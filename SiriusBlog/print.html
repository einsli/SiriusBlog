<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js navy">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Sirius运维开发笔记</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="Sirius运维开发笔记">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> 简介</a></li><li class="chapter-item expanded "><a href="operations.html"><strong aria-hidden="true">2.</strong> 基础运维</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="operations/linux.html"><strong aria-hidden="true">2.1.</strong> linux</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="operations/linux/linux_base_config.html"><strong aria-hidden="true">2.1.1.</strong> linux 基础配置</a></li><li class="chapter-item expanded "><a href="operations/linux/linux_kernel_upgrade.html"><strong aria-hidden="true">2.1.2.</strong> linux 内核升级</a></li><li class="chapter-item expanded "><a href="operations/linux/linux_supervisor_install.html"><strong aria-hidden="true">2.1.3.</strong> supervisord 安装配置</a></li></ol></li><li class="chapter-item expanded "><a href="operations/docker.html"><strong aria-hidden="true">2.2.</strong> docker</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="operations/docker/linux_docker_installed.html"><strong aria-hidden="true">2.2.1.</strong> docker 安装与配置</a></li><li class="chapter-item expanded "><a href="operations/docker/linux_docker_compose_installed.html"><strong aria-hidden="true">2.2.2.</strong> docker-compose 安装</a></li></ol></li><li class="chapter-item expanded "><a href="operations/redis.html"><strong aria-hidden="true">2.3.</strong> redis</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="operations/redis/redis_binary_installed.html"><strong aria-hidden="true">2.3.1.</strong> redis 二进制安装与配置</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="cloud_operations.html"><strong aria-hidden="true">3.</strong> 云原生</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cloud_operations/monitor.html"><strong aria-hidden="true">3.1.</strong> 监控</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cloud_operations/monitor/n9e_install.html"><strong aria-hidden="true">3.1.1.</strong> 夜莺监控安装配置</a></li><li class="chapter-item expanded "><a href="cloud_operations/monitor/n9e_ldap_config.html"><strong aria-hidden="true">3.1.2.</strong> 夜莺配置 ldap 单点登录</a></li><li class="chapter-item expanded "><a href="cloud_operations/monitor/alert_prom_sql.html"><strong aria-hidden="true">3.1.3.</strong> prometheus 监控告警 sql</a></li></ol></li><li class="chapter-item expanded "><a href="cloud_operations/kubernetes.html"><strong aria-hidden="true">3.2.</strong> kubernetes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cloud_operations/kubernetes/kubernetes_sa.html"><strong aria-hidden="true">3.2.1.</strong> kubernetes service account</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cloud_operations/kubernetes/kubernetes_sa/k8s_sa_kubeconfig.html"><strong aria-hidden="true">3.2.1.1.</strong> k8s 基于 sa 创建 kubeconfig 访问(集群版)</a></li></ol></li><li class="chapter-item expanded "><a href="cloud_operations/kubernetes/kubernetes_issues.html"><strong aria-hidden="true">3.2.2.</strong> k8s 相关问题</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cloud_operations/kubernetes/kubernetes_issues/k8s_secret_issues.html"><strong aria-hidden="true">3.2.2.1.</strong> kubernetes secret 相关问题</a></li></ol></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Sirius运维开发笔记</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/einsli/SiriusBlog" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="sirius-运维笔记"><a class="header" href="#sirius-运维笔记">Sirius 运维笔记</a></h1>
<blockquote>
<p>运维开发攻城狮一枚，目前在杭州，主要做 CICD, K8S 运维相关,技术宅！</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="基础运维"><a class="header" href="#基础运维">基础运维</a></h1>
<p>这里主要是基础运维，涉及到基础环境搭建以及配置.</p>
<ul>
<li>
<p><a href="operations/linux.html">linux</a></p>
</li>
<li>
<p><a href="operations/docker.html">docker</a></p>
</li>
<li>
<p><a href="operations/redis.html">redis</a></p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-基础运维"><a class="header" href="#linux-基础运维">linux 基础运维</a></h1>
<p>这里主要是 linux 基础运维，涉及到 linux 基础环境搭建以及配置和相关问题的处理.</p>
<ul>
<li>
<p><a href="operations/linux/linux_base_config.html">linux 基础配置</a></p>
</li>
<li>
<p><a href="operations/linux/linux_kernel_upgrade.html">linux 内核升级</a></p>
</li>
<li>
<p><a href="operations/linux/linux_supervisor_install.html">supervisord 安装配置</a></p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-基础配置"><a class="header" href="#linux-基础配置">linux 基础配置</a></h1>
<h2 id="一务器系统配置初始化脚本"><a class="header" href="#一务器系统配置初始化脚本">一、务器系统配置初始化脚本</a></h2>
<p>当拿到一台 linux 服务器，需要对 linux 做一些操作，来保证后续部署的服务能够高效稳定的运行。</p>
<h3 id="11-关闭-swap-分区"><a class="header" href="#11-关闭-swap-分区">1.1 关闭 swap 分区</a></h3>
<p><strong>临时关闭</strong></p>
<pre><code class="language-shell">swapoff -a
</code></pre>
<p><strong>永久关闭</strong></p>
<p>打开文件<code>/etc/fstab</code></p>
<pre><code class="language-shell">vim /etc/fstab
</code></pre>
<p>找到<code>swap</code>分区将其注释掉即可</p>
<pre><code class="language-PlainText">#/dev/mapper/cl-swap     swap                    swap    defaults        0 0
</code></pre>
<p><strong>重启机器</strong></p>
<pre><code class="language-shell">reboot
</code></pre>
<h3 id="12-关闭-selinux"><a class="header" href="#12-关闭-selinux">1.2 关闭 selinux</a></h3>
<p><strong>查看 selinux 状态</strong></p>
<pre><code class="language-shell">getenforce
</code></pre>
<p><img src="operations/linux/../../images/operations/linux/enable_selinux.png" alt="avar" /></p>
<p><strong>临时关闭</strong></p>
<pre><code class="language-shell">setenforce 0
</code></pre>
<p>重启系统后还会开启</p>
<p><strong>永久关闭</strong></p>
<pre><code class="language-shell">sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux
</code></pre>
<p><strong>重启机器</strong></p>
<pre><code class="language-shell">reboot
</code></pre>
<p><strong>关闭后查看 selinux 状态</strong></p>
<pre><code class="language-shell">getenforce
</code></pre>
<p><img src="operations/linux/../../images/operations/linux/disable_selinux.png" alt="avar" /></p>
<h3 id="13-关闭防火墙"><a class="header" href="#13-关闭防火墙">1.3 关闭防火墙</a></h3>
<p>关闭防火墙命令如下</p>
<pre><code class="language-shell">systemctl stop firewalld &amp;&amp; systemctl disable firewalld
</code></pre>
<h3 id="14-主机名配置"><a class="header" href="#14-主机名配置">1.4 主机名配置</a></h3>
<p>拿到主机后，需要给服务器配置一个主机名，就像每个人有自己的名字一样</p>
<p>配置主机名命令如下</p>
<pre><code class="language-shell">hostnamectl --static set-hostname sirius
</code></pre>
<h3 id="15-ssh-配置"><a class="header" href="#15-ssh-配置">1.5 ssh 配置</a></h3>
<p><strong>关闭 DNS 反查</strong>
使用了 dns 反查，这种情况下当 ssh 登录某个 IP 时，系统会试图通过 DNS 反查相对应的域名，如果 DNS 中没有这个 IP 的域名解析，则会等到 DNS 查询超时才会进行下一步，消耗很长时间。</p>
<p>关闭 dns 反查命令如下</p>
<pre><code class="language-shell">sed -ie &quot;/UseDNS/s/yes/no/g;/UseDNS/s/#//g&quot; /etc/ssh/sshd_config
</code></pre>
<p><strong>修改 ssh 超时时间</strong></p>
<pre><code class="language-shell">vim /etc/ssh/sshd_config
</code></pre>
<p>修改下面两项</p>
<pre><code class="language-PlainText">ClientAliveInterval 60
ClientAliveCountMax 30
</code></pre>
<p><strong>重启 ssh 服务</strong></p>
<pre><code class="language-shell">systemctl restart sshd
</code></pre>
<h3 id="16-修改系统时区"><a class="header" href="#16-修改系统时区">1.6 修改系统时区</a></h3>
<p>查看系统时区是否正常</p>
<p><img src="operations/linux/../../images/operations/linux/shanghai_timezone.png" alt="avar" /></p>
<p>上述图片是已经修改正常状态</p>
<p>修改系统时间命令如下</p>
<pre><code class="language-shell">mv /etc/localtime /etc/localtime.bak
-s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</code></pre>
<p>然后输入上图命令即可验证时间即可</p>
<h4 id="参考文档"><a class="header" href="#参考文档">参考文档</a></h4>
<p><a href="http://bluebiu.com/blog/linux-ssh-session-alive.html">1.Linux 使用 ssh 超时断开连接的真正原因</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-内核升级"><a class="header" href="#linux-内核升级">linux 内核升级</a></h1>
<h2 id="一在线升级"><a class="header" href="#一在线升级">一、在线升级</a></h2>
<p>本升级方法适用于所有 Centos7.x 系列的 OS</p>
<h3 id="11-查看当前内核版本"><a class="header" href="#11-查看当前内核版本">1.1 查看当前内核版本</a></h3>
<pre><code class="language-shell">$ uname -r
3.10.0-514.el7.x86_64

$ uname -a
Linux hecs-133409 4.18.0-240.10.1.el8_3.x86_64 #1 SMP Mon Jan 18 17:05:51 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux

$ cat /etc/redhat-release
CentOS Linux release 7.3.1611 (Core)
</code></pre>
<h3 id="22-升级内核"><a class="header" href="#22-升级内核">2.2 升级内核</a></h3>
<h4 id="221-更新-yum-仓库"><a class="header" href="#221-更新-yum-仓库">2.2.1 更新 yum 仓库</a></h4>
<pre><code class="language-shell">yum update
</code></pre>
<h4 id="222-启用-elrepo-仓库"><a class="header" href="#222-启用-elrepo-仓库">2.2.2 启用 ELRepo 仓库</a></h4>
<p>ELRepo 仓库是基于社区的用于企业级 Linux 仓库，提供对 RedHat Enterprise (RHEL) 和 其他基于 RHEL 的 Linux 发行版（CentOS、Scientific、Fedora 等）的支持。
ELRepo 聚焦于和硬件相关的软件包，包括文件系统驱动、显卡驱动、网络驱动、声卡驱动和摄像头驱动等。</p>
<h4 id="1-导入-elrepo-仓库的公共密钥"><a class="header" href="#1-导入-elrepo-仓库的公共密钥">(1) 导入 ELRepo 仓库的公共密钥</a></h4>
<pre><code class="language-shell">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
</code></pre>
<h4 id="2-安装-elrepo-仓库的-yum-源"><a class="header" href="#2-安装-elrepo-仓库的-yum-源">(2) 安装 ELRepo 仓库的 yum 源</a></h4>
<pre><code class="language-shell">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm
</code></pre>
<h4 id="3-查看可用的系统内核包"><a class="header" href="#3-查看可用的系统内核包">(3) 查看可用的系统内核包</a></h4>
<pre><code class="language-shell">yum --disablerepo=&quot;*&quot; --enablerepo=&quot;elrepo-kernel&quot; list available
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
* elrepo-kernel: mirrors.tuna.tsinghua.edu.cn
  elrepo-kernel                                                                         | 2.9 kB  00:00:00
  elrepo-kernel/primary_db                                                              | 1.8 MB  00:00:03
  Available Packages
  kernel-lt.x86_64                                   4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-lt-devel.x86_64                             4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-lt-doc.noarch                               4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-lt-headers.x86_64                           4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-lt-tools.x86_64                             4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-lt-tools-libs.x86_64                        4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-lt-tools-libs-devel.x86_64                  4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-ml.x86_64                                   4.18.7-1.el7.elrepo                     elrepo-kernel
  kernel-ml-devel.x86_64                             4.18.7-1.el7.elrepo                     elrepo-kernel
  kernel-ml-doc.noarch                               4.18.7-1.el7.elrepo                     elrepo-kernel
  kernel-ml-headers.x86_64                           4.18.7-1.el7.elrepo                     elrepo-kernel
  kernel-ml-tools.x86_64                             4.18.7-1.el7.elrepo                     elrepo-kernel
  kernel-ml-tools-libs.x86_64                        4.18.7-1.el7.elrepo                     elrepo-kernel
  kernel-ml-tools-libs-devel.x86_64                  4.18.7-1.el7.elrepo                     elrepo-kernel
  perf.x86_64                                        4.18.7-1.el7.elrepo                     elrepo-kernel
  python-perf.x86_64                                  4.18.7-1.el7.elrepo                    elrepo-kernel
</code></pre>
<h4 id="4-安装最新版本内核"><a class="header" href="#4-安装最新版本内核">(4) 安装最新版本内核</a></h4>
<pre><code class="language-shell">yum --enablerepo=elrepo-kernel install kernel-ml
</code></pre>
<p><font color='red'><strong>--enablerepo</strong></font> 选项开启 CentOS 系统上的指定仓库。默认开启的是<font color='red'><strong>elrepo</strong></font>，这里用 <font color='red'><strong>-kernel</strong></font> 替换</p>
<h4 id="5-设置-grub2"><a class="header" href="#5-设置-grub2">(5) 设置 grub2</a></h4>
<p>内核安装好后，需要设置为默认启动选项并重启后才会生效</p>
<p>1、 查看系统上的所有可用内核</p>
<pre><code class="language-shell">awk -F\' '$1==&quot;menuentry &quot; {print i++ &quot; : &quot; $2}' /etc/grub2.cfg
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">0 : CentOS Linux (4.18.7-1.el7.elrepo.x86_64) 7 (Core)
1 : CentOS Linux (3.10.0-862.11.6.el7.x86_64) 7 (Core)
2 : CentOS Linux (3.10.0-514.el7.x86_64) 7 (Core)
3 : CentOS Linux (0-rescue-063ec330caa04d4baae54c6902c62e54) 7 (Core)
</code></pre>
<p>2、设置新的内核为 grub2 的默认版本</p>
<p>服务器上存在 4 个内核，我们要使用 4.18 这个版本，可以通过 grub2-set-default 0 命令或编辑 /etc/default/grub 文件来设置</p>
<p>方法一、通过 <font color='red'><strong>grub2-set-default 0</strong></font> 命令设置</p>
<p>其中 0 是上面查询出来的可用内核</p>
<pre><code class="language-shell">grub2-set-default 0
</code></pre>
<p>方法二、编辑 <font color='red'><strong>/etc/default/grub</strong></font> 文件
设置 GRUB_DEFAULT=0，通过上面查询显示的编号为 0 的内核作为默认内核</p>
<pre><code class="language-shell">vim /etc/default/grub
</code></pre>
<pre><code class="language-PlainText">GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR=&quot;$(sed 's, release .*$,,g' /etc/system-release)&quot;
GRUB_DEFAULT=0
GRUB_DISABLE_SUBMENU=true
GRUB_TERMINAL_OUTPUT=&quot;console&quot;
GRUB_CMDLINE_LINUX=&quot;crashkernel=auto rd.lvm.lv=cl/root rhgb quiet&quot;
GRUB_DISABLE_RECOVERY=&quot;true&quot;
</code></pre>
<p>3、生成 grub 配置文件并重启</p>
<pre><code class="language-shell">grub2-mkconfig -o /boot/grub2/grub.cfg
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">Generating grub configuration file ...
Found linux image: /boot/vmlinuz-4.18.7-1.el7.elrepo.x86_64
Found initrd image: /boot/initramfs-4.18.7-1.el7.elrepo.x86_64.img
Found linux image: /boot/vmlinuz-3.10.0-862.11.6.el7.x86_64
Found initrd image: /boot/initramfs-3.10.0-862.11.6.el7.x86_64.img
Found linux image: /boot/vmlinuz-3.10.0-514.el7.x86_64
Found initrd image: /boot/initramfs-3.10.0-514.el7.x86_64.img
Found linux image: /boot/vmlinuz-0-rescue-063ec330caa04d4baae54c6902c62e54
Found initrd image: /boot/initramfs-0-rescue-063ec330caa04d4baae54c6902c62e54.img
done
</code></pre>
<p>重启</p>
<pre><code class="language-shell">reboot
</code></pre>
<p>4、验证</p>
<pre><code class="language-shell">uname -r
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">4.18.7-1.el7.elrepo.x86_64
</code></pre>
<h3 id="23-删除旧的内核可选"><a class="header" href="#23-删除旧的内核可选">2.3 删除旧的内核（可选）</a></h3>
<h4 id="231-查看系统中全部的内核"><a class="header" href="#231-查看系统中全部的内核">2.3.1 查看系统中全部的内核</a></h4>
<pre><code class="language-shell">rpm -qa | grep kernel
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">kernel-3.10.0-514.el7.x86_64
kernel-ml-4.18.7-1.el7.elrepo.x86_64
kernel-tools-libs-3.10.0-862.11.6.el7.x86_64
kernel-tools-3.10.0-862.11.6.el7.x86_64
kernel-3.10.0-862.11.6.el7.x86_64
</code></pre>
<h4 id="232-删除内核"><a class="header" href="#232-删除内核">2.3.2 删除内核</a></h4>
<p>方法一 通过 <font color='red'><strong>yum remove</strong></font>删除</p>
<pre><code class="language-shell">yum remove kernel-3.10.0-514.el7.x86_64 \
kernel-ml-4.18.7-1.el7.elrepo.x86_64 \
kernel-tools-libs-3.10.0-862.11.6.el7.x86_64 \
kernel-tools-3.10.0-862.11.6.el7.x86_64 \
kernel-3.10.0-862.11.6.el7.x86_64
</code></pre>
<p>方法二：使用 <font color='red'><strong>yum-utils</strong></font>工具删除</p>
<p>如果安装的内核不多于 3 个，<font color='red'><strong>yum-utils</strong></font> 工具不会删除任何一个。只有在安装的内核大于 3 个时，才会自动删除旧内核。</p>
<p>安装 yum-utils</p>
<pre><code class="language-shell">yum install yum-utils
</code></pre>
<p>删除旧版本</p>
<pre><code class="language-shell">package-cleanup --oldkernels
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="supervisor-安装与配置"><a class="header" href="#supervisor-安装与配置">supervisor 安装与配置</a></h1>
<p>执行以下命令安装 supervisord</p>
<pre><code class="language-shell">yum install supervisor
</code></pre>
<p>查看版本</p>
<pre><code class="language-shell">supervisord --version
</code></pre>
<p>如果需要配置界面访问需要修改<code>supervisord.conf</code></p>
<p>路径如下</p>
<pre><code class="language-PlainText">/etc/supervisord.conf
</code></pre>
<p>修改以下几行</p>
<pre><code class="language-PlainText">#启用访问web控制界面，inet_http_server 修改如下
[inet_http_server]
port=*:9001

#设置账户和密码
username=user
password=passw0rd

#include part
[include]
files = supervisord.d/*.ini
</code></pre>
<p>子进程配置文件路径：<code>/etc/supervisord.d/</code></p>
<p>这是官网的配置文件 👉🏻<a href="http://www.supervisord.org/configuration.html">supervisord 配置文件参考</a></p>
<p>在<code>/etc/supervisord.d/</code> 创建<code>test-server.ini</code>,用于启动一个<code>java</code>服务</p>
<pre><code class="language-ini">[program:javaserver]
command=/usr/bin/java -jar app.jar ; 输入执行命令，这里表示 dotnet  demo.dll
directory=/opt/test-server ; 应用程序根目录
autostart=true ; 是否自动启动，当 supervisor 加载该配置文件的时候立即启动它
autorestart=true ; 是否自动重启，当执行 dotnet  Deploy.Linux.dll 启动失败时，会重复的自动重启
logfile_maxbytes=50MB ; 该配置文件输出单个日志文件的大小
logfile_backups=10 ; 日志备份个数
loglevel=info ; 记录日志级别
stderr_logfile=/data/logs/java-server.err.log ; 指定标准错误输出日志文件
stdout_logfile=/data/logs/java-server.access.log ; 指定标准输出日志文件
environment=ASPNETCORE_ENVIRONMENT=Production ; 可配置环境变量，该环境变量将通过执行 dotnet  Deploy.Linux.dll 命令的时候传入到 .NET Core 应用程序中
user=root ;启动服务的用户
stopsignal=INT
redirect_stderr=true
</code></pre>
<p>创建日志路径</p>
<pre><code class="language-shell">mkdir -p /data/logs/
</code></pre>
<p>重新加载配置</p>
<pre><code class="language-shell">systemctl daemon-reload
</code></pre>
<p>启动<code>supervisord</code>并设置为开机启动</p>
<pre><code class="language-shell"># 启动supervisord
systemctl start supervisord

# 设置开机启动
systemctl enable supervisord

# 查看supervisord 状态
systemctl status supervisord
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker-基础运维"><a class="header" href="#docker-基础运维">docker 基础运维</a></h1>
<p>这里主要是 docker 基础运维，涉及到 docker 基础环境搭建以及配置和相关问题的处理.</p>
<ul>
<li>
<p><a href="operations/docker/linux_docker_installed.html">docker 安装与配置</a></p>
</li>
<li>
<p><a href="operations/docker/linux_docker_compose_installed.html">linux docker-compose 安装</a></p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-docker-安装与配置"><a class="header" href="#linux-docker-安装与配置">linux docker 安装与配置</a></h1>
<h2 id="一docker-离线安装"><a class="header" href="#一docker-离线安装">一、docker 离线安装</a></h2>
<h3 id="11下载离线安装包"><a class="header" href="#11下载离线安装包">1.1、下载离线安装包</a></h3>
<blockquote>
<p>访问地址: <a href="https://download.docker.com/linux/static/stable/x86_64/">docker 离线下载地址</a></p>
<p>选择对应版本,此处选择<code>docker-20-10.8.tgz</code></p>
</blockquote>
<p><img src="operations/docker/../../images/operations/docker/docker_version_selected.png" alt="avatar" /></p>
<p>可以下载到本地后上传至服务器，或者在服务器执行以下命令直接下载</p>
<pre><code class="language-shell">yum -y install wget &amp;&amp; wget https://download.docker.com/linux/static/stable/x86_64/docker-20.10.8.tgz
</code></pre>
<h3 id="12解压安装"><a class="header" href="#12解压安装">1.2、解压安装</a></h3>
<p>执行以下命令，对第一步下载的<code>docker-20.10.8.tgz</code>进行解压</p>
<pre><code class="language-shell">tar -zxvf docker-20.10.8.tgz
</code></pre>
<p>解压后会得到一个<code>docker</code>文件夹</p>
<p><img src="operations/docker/../../images/operations/docker/docker_extract.png" alt="avatar" /></p>
<p>执行以下命令，将 docker 命令添加到<code>/usr/bin/</code>目录下</p>
<pre><code class="language-shell">cp docker/* /usr/bin/
</code></pre>
<p>验证</p>
<p>输入以下命令，验证是否生效</p>
<pre><code class="language-shell">docker version
</code></pre>
<p><img src="operations/docker/../../images/operations/docker/docker_test.png" alt="avatar" /></p>
<p>出现上述则说明安装成功，最下面的报错可以忽略，因为目前<code>docker</code>还没启动</p>
<h3 id="13启动-docker"><a class="header" href="#13启动-docker">1.3、启动 docker</a></h3>
<p>需要配置 docker.service</p>
<p>docker.service 内容如下</p>
<pre><code class="language-shell">cat &gt; docker.service &lt;&lt; EOF
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service containerd.service
Wants=network-online.target

[Service]
Type=notify
ExecStart=/usr/bin/dockerd
ExecReload=/bin/kill -s HUP $MAINPID
TimeoutSec=0
RestartSec=2
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process

[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<p>移动 docker.service 到如下目录</p>
<pre><code class="language-shell">mv docker.service /usr/lib/systemd/system/
</code></pre>
<p>重新加载配置</p>
<pre><code class="language-shell">systemctl daemon-reload
</code></pre>
<p>启动 docker</p>
<pre><code class="language-shell">systemctl start docker
</code></pre>
<p>设置开机自启</p>
<pre><code class="language-shell">systemctl enable docker
</code></pre>
<p>验证</p>
<p>输入以下命令，即可查看 docker 是否启动</p>
<pre><code class="language-shell">systemctl status docker
</code></pre>
<p><img src="operations/docker/../../images/operations/docker/docker_status.png" alt="avatar" /></p>
<p>启动成功，到此 docker 安装结束!</p>
<h2 id="二docker-在线安装"><a class="header" href="#二docker-在线安装">二、docker 在线安装</a></h2>
<h3 id="21卸载已有-docker-服务"><a class="header" href="#21卸载已有-docker-服务">2.1、卸载已有 docker 服务</a></h3>
<pre><code class="language-shell">yum remove docker \
     docker-client \
     docker-client-latest \
     docker-common \
     docker-latest \
     docker-latest-logrotate \
     docker-logrotate \
     docker-engine
</code></pre>
<h3 id="22安装-epel-更新源"><a class="header" href="#22安装-epel-更新源">2.2、安装 epel 更新源</a></h3>
<pre><code class="language-shell">yum install -y epel-release
</code></pre>
<h3 id="23安装-docker-仓库"><a class="header" href="#23安装-docker-仓库">2.3、安装 docker 仓库</a></h3>
<pre><code>yum install -y yum-utils device-mapper-persistent-data lvm2
</code></pre>
<p>设置稳定仓库，将指定文件或 url 添加为 yum 源并启用</p>
<pre><code class="language-shell"># 官方源
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 官方源速度较慢，可以修改为添加国内原
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</code></pre>
<p><strong>如果提示<code>yum-config-manager not found</code>，请执行以下命令安装</strong></p>
<pre><code class="language-shell">yum install yum-utils
</code></pre>
<h3 id="24安装-docker"><a class="header" href="#24安装-docker">2.4、安装 docker</a></h3>
<p>按版本号排序列出存储库中可用的版本号</p>
<pre><code class="language-PlainText">(base) [root@moushi-ops-navigation-100 ~]# yum list docker-ce --showduplicates | sort -r
docker-ce.x86_64            3:24.0.6-1.el7                      docker-ce-stable
docker-ce.x86_64            3:24.0.5-1.el7                      docker-ce-stable
docker-ce.x86_64            3:24.0.4-1.el7                      docker-ce-stable
docker-ce.x86_64            3:24.0.3-1.el7                      docker-ce-stable
docker-ce.x86_64            3:24.0.2-1.el7                      docker-ce-stable
docker-ce.x86_64            3:24.0.1-1.el7                      docker-ce-stable
docker-ce.x86_64            3:24.0.0-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.6-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.5-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.4-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.3-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.2-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.1-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.0-1.el7                      docker-ce-stable
......
</code></pre>
<p>根据需要自行选择需要安装的版本</p>
<pre><code class="language-shell"># 默认安装最新版本docker
yum install -y docker-ce docker-ce-cli containerd.io

# 此处安装指定版本docker
yum install -y docker-ce-23.0.0-1.el7 docker-ce-cli-23.0.0-1.el7 containerd.io

# 安装docker命令补全工具
yum install -y bash-completion
</code></pre>
<h3 id="25启动-docker"><a class="header" href="#25启动-docker">2.5、启动 docker</a></h3>
<p>启动 docker</p>
<pre><code class="language-shell">systemctl start docker
</code></pre>
<p>设置开机自启</p>
<pre><code class="language-shell">systemctl enable docker
</code></pre>
<h2 id="三docker-配置"><a class="header" href="#三docker-配置">三、docker 配置</a></h2>
<h3 id="31-配置-docker-镜像下载加速器"><a class="header" href="#31-配置-docker-镜像下载加速器">3.1 配置 docker 镜像下载加速器</a></h3>
<pre><code class="language-shell">tee /etc/docker/daemon.json &lt;&lt; eof
{
    &quot;registry-mirrors&quot;: [
        &quot;https://1nj0zren.mirror.aliyuncs.com&quot;,
        &quot;https://docker.mirrors.ustc.edu.cn&quot;,
        &quot;http://f1361db2.m.daocloud.io&quot;,
        &quot;https://registry.docker-cn.com&quot;
    ]
}
eof
</code></pre>
<h3 id="32-修改-docker-的默认镜像容器数据存储位置"><a class="header" href="#32-修改-docker-的默认镜像容器数据存储位置">3.2 修改 docker 的默认镜像、容器数据存储位置</a></h3>
<p>docker 的默认存储位置是 /var/lib/docker/ ，在根目录下，docker 运行一段时间后，会导致根目录存储爆炸。所有最好将存储位置自定义到服务器存储最大的目录下。</p>
<p>然后在 <code>/etc/docker/daemon.json</code> 文件中指定默认存储路径（此路径可自定义），添加以下内容：</p>
<pre><code class="language-PlainText">&quot;data-root&quot;: &quot;/vdb/docker_images&quot;
</code></pre>
<p>修改如下</p>
<pre><code class="language-json">{
  &quot;registry-mirrors&quot;: [
    &quot;https://1nj0zren.mirror.aliyuncs.com&quot;,
    &quot;https://docker.mirrors.ustc.edu.cn&quot;,
    &quot;http://f1361db2.m.daocloud.io&quot;,
    &quot;https://registry.docker-cn.com&quot;
  ],
  &quot;data-root&quot;: &quot;/vdb/docker_images&quot;
}
</code></pre>
<h3 id="33-重新加载配置与重启-docker"><a class="header" href="#33-重新加载配置与重启-docker">3.3 重新加载配置与重启 docker</a></h3>
<p>重新加载配置</p>
<pre><code class="language-shell">systemctl daemon-reload
</code></pre>
<p>重新启动 docker</p>
<pre><code class="language-shell">systemctl restart docker
</code></pre>
<h4 id="参考文档-1"><a class="header" href="#参考文档-1">参考文档</a></h4>
<p><a href="https://blog.csdn.net/Sara_cloud/article/details/111193087">1.Docker 系列之一：在线安装 docker 和下载镜像</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-docker-compose-安装"><a class="header" href="#linux-docker-compose-安装">linux docker-compose 安装</a></h1>
<h2 id="前期准备"><a class="header" href="#前期准备">前期准备</a></h2>
<blockquote>
<p>安装之前，请先确保 docker 已经安装，如果没有安装，请参考<a href="operations/docker/linux_docker_installed.html">linux docker 安装与配置</a></p>
<p>docker-compose 各版本 <a href="https://github.com/docker/compose/releases">下载地址</a></p>
</blockquote>
<h2 id="二进制安装-docker-compose"><a class="header" href="#二进制安装-docker-compose">二进制安装 docker-compose</a></h2>
<p>1、下载对应 linux 版本的 docker-compose 二进制文件</p>
<pre><code class="language-shell">yum -y install wget
wget https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-linux-x86_64
</code></pre>
<p>2、赋予执行权限</p>
<pre><code class="language-shell">chmod +x docker-compose-linux-x86_64
</code></pre>
<p>3、移动到<code>/usr/bin/</code> 路径下，并重命名为<code>docker-compose</code></p>
<pre><code class="language-shell">mv docker-compose-linux-x86_64 /usr/bin/docker-compose
</code></pre>
<p>4、验证并查看版本</p>
<pre><code class="language-shell">docker-compose version
</code></pre>
<p>如下图所示，则安装成功</p>
<p><img src="operations/docker/../../images/operations/docker/docker-compose-version.png" alt="avatar" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="redis-基础运维"><a class="header" href="#redis-基础运维">redis 基础运维</a></h1>
<p>这里主要是 redis 基础运维，涉及到 redis 基础环境搭建以及配置和相关问题的处理.</p>
<ul>
<li><a href="operations/redis/redis_binary_installed.html">redis 二进制安装与配置</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="redis-二进制安装与配置"><a class="header" href="#redis-二进制安装与配置">redis 二进制安装与配置</a></h1>
<blockquote>
<p>redis 各版本<a href="http://download.redis.io/releases/">下载地址</a></p>
</blockquote>
<h2 id="前期准备-1"><a class="header" href="#前期准备-1">前期准备</a></h2>
<p>依赖<code>c</code>环境</p>
<p>如果没有安装<code>c</code>环境，执行以下命令，部署安装<code>c</code>环境</p>
<pre><code class="language-shell">yum -y install gcc-c++
</code></pre>
<h2 id="二进制安装"><a class="header" href="#二进制安装">二进制安装</a></h2>
<p>这里采用了源码编译安装，版本是 7.0.8</p>
<pre><code class="language-shell"># 下载源码包
yum -y install wget &amp;&amp; wget http://download.redis.io/releases/redis-7.0.8.tar.gz

# 解压
tar -zxvf redis-7.0.8.tar.gz -C /usr/local

# 编译安装
cd /usr/local/redis-7.0.8
make &amp;&amp; make install
</code></pre>
<h2 id="配置-redis"><a class="header" href="#配置-redis">配置 redis</a></h2>
<p>redis 的默认配置文件就是位于 redis 安装目录下的 redis.conf</p>
<p>即<code>/usr/local/redis-7.0.8</code> 目录下</p>
<p>去掉 redis 注释信息，重新生成新的 redis_6379.conf</p>
<pre><code class="language-shell">cat redis.conf | grep -v &quot;#&quot; | grep -v &quot;^$&quot; &gt; redis-6379.conf
</code></pre>
<p>需要将<code>redis-6379.conf</code>配置中<code>dir</code>的值做如下修改</p>
<pre><code class="language-PlainText">dir /opt/redis/db
</code></pre>
<p>打开守护进程</p>
<pre><code class="language-PlainText">daemonize yes
</code></pre>
<p>修改 redis 日志路径</p>
<pre><code class="language-PlainText">logfile /var/log/redis/redis.log
</code></pre>
<p>以守护进程方式启动，使用本启动方式，redis 将以服务的形式存在，日志将不再打印到命令窗口中</p>
<p>在’/opt’目录下新建<code>redis</code>目录，用于存放<code>conf</code> 配置文件, <code>db</code>数据存储等</p>
<pre><code class="language-shell">mkdir -p /opt/redis/conf /opt/redis/db
mv /usr/local/redis-7.0.8/redis-6379.conf /opt/redis/conf
</code></pre>
<p>在<code>/var/log/</code>目录下创建 redis 文件夹，用于记录 redis 的日志输出</p>
<pre><code class="language-shell">mkdir /var/log/redis
</code></pre>
<h2 id="启动-redis"><a class="header" href="#启动-redis">启动 redis</a></h2>
<p>准备<code>redis.service</code>文件</p>
<pre><code class="language-shell">cat &gt; redis.service &lt;&lt; EOF
[Unit]
Description=Redis server
After=syslog.target network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
ExecStart=/bin/bash -c '/usr/local/bin/redis-server /opt/redis/conf/redis-6379.conf'
ExecStop=/bin/bash -c '/usr/local/bin/redis-cli shutdown'
Restart=always
PrivateTmp=true

[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<p>配置 redis system 启动</p>
<p>将生成的 redis.service 文件移动到 <code>/usr/lib/systemd/system/</code>目录下</p>
<pre><code class="language-shell">mv redis.service /usr/lib/systemd/system/
</code></pre>
<p>启动 redis</p>
<pre><code class="language-shell">systemctl daemon-reload
systemctl enable redis
systemctl start redis
</code></pre>
<p>查看 redis 启动状态</p>
<pre><code class="language-shell">systemctl status redis
</code></pre>
<p>如下图所示，则启动成功</p>
<p><img src="operations/redis/../../images/operations/redis/redis_status.png" alt="avatar" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="云原生"><a class="header" href="#云原生">云原生</a></h1>
<p>这里主要是云原生运维，涉及到 docker,k8s,prometheus 监控等一系列云原生相关组件的安装配置与使用问题.</p>
<ul>
<li><a href="cloud_operations/monitor.html">监控</a></li>
<li><a href="cloud_operations/kubernetes.html">kubernets</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="云原生监控"><a class="header" href="#云原生监控">云原生监控</a></h1>
<p>这里主要是 监控，涉及到 prometheus alertmanager grafana 等相关组件的安装使用与监控配置等.</p>
<ul>
<li>
<p><a href="cloud_operations/monitor/n9e_install.html">夜莺部署安装</a></p>
</li>
<li>
<p><a href="cloud_operations/monitor/n9e_ldap_config.html">夜莺配置 ldap 单点登录</a></p>
</li>
<li>
<p><a href="cloud_operations/monitor/alert_prom_sql.html">prometheus 监控 sql</a></p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="夜莺安装与配置"><a class="header" href="#夜莺安装与配置">夜莺安装与配置</a></h1>
<p><a href="https://flashcat.cloud/docs/content/flashcat-monitor/nightingale-v6/install/intro/">夜莺官方部署文档</a></p>
<p>夜莺官方推荐二进制安装，具体安装步骤参考与官网</p>
<h2 id="一二进制安装夜莺"><a class="header" href="#一二进制安装夜莺">一、二进制安装夜莺</a></h2>
<h3 id="11-部署安装-mysql"><a class="header" href="#11-部署安装-mysql">1.1 部署安装 mysql</a></h3>
<p>安装 mysql</p>
<pre><code class="language-shell">yum -y install mariadb*
systemctl enable mariadb
systemctl restart mariadb
</code></pre>
<p>设置登陆密码</p>
<pre><code class="language-shell">mysql -e &quot;SET PASSWORD FOR 'root'@'localhost' = PASSWORD('passw0rd');&quot;
</code></pre>
<p>开启远程登录</p>
<p>登录 mysql 后，执行一下语句，开启远程登录</p>
<pre><code class="language-sql">GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'passw0rd' WITH GRANT OPTION;
</code></pre>
<h3 id="12-部署安装-redis"><a class="header" href="#12-部署安装-redis">1.2 部署安装 redis</a></h3>
<p>这里采用二进制安装，请参考 <a href="cloud_operations/monitor/../../operations/redis/redis_binary_installed.html">redis 二进制安装与配置</a></p>
<h3 id="13-部署夜莺"><a class="header" href="#13-部署夜莺">1.3 部署夜莺</a></h3>
<p><strong>安装夜莺</strong></p>
<p>夜莺最新安装包<a href="https://flashcat.cloud/download/nightingale/">下载地址</a>,截止到目前，最近版本是<code>v6.1.0</code></p>
<p>(1) 创建个 n9e 的目录，后面把 n9e 相关的文件解压到这里</p>
<pre><code class="language-shell">mkdir -p /opt/n9e &amp;&amp; cd /opt/n9e
</code></pre>
<p>(2) 下载 n9e 发布包，amd64 是 x84 的包，下载站点也提供 arm64 的包，如果需要其他平台的包则要自行编译了</p>
<pre><code class="language-shell">tarball=n9e-v6.0.1-linux-amd64.tar.gz
urlpath=https://download.flashcat.cloud/${tarball}
wget -q $urlpath || exit 1
</code></pre>
<p>(3)解压安装包到<code>/opt/n9e</code></p>
<pre><code class="language-shell">tar -zxvf n9e-v6.0.1-linux-amd64.tar.gz -C /opt/n9e/
</code></pre>
<p>(4) 解压缩之后，可以看到 n9e.sql 是建表语句，导入数据库</p>
<pre><code class="language-shell">mysql -uroot -ppassw0rd &lt; n9e.sql
</code></pre>
<p><strong>注:</strong> passw0rd 为第一步创建 mariab 时候的创建的密码</p>
<p>(5) 修改<code>n9e</code>数据库配置</p>
<p>配置文件在安装目录下 <code>etc/config.toml</code></p>
<pre><code class="language-shell">DSN=&quot;root:passw0rd@tcp(127.0.0.1:3306)/n9e_v6?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&amp;allowNativePasswords=true&quot;
</code></pre>
<p>(6) 启动测试</p>
<p>启动 n9e</p>
<pre><code class="language-shell">nohup ./n9e &amp;&gt; n9e.log &amp;
</code></pre>
<p>检查 n9e.log 是否有异常日志，检查端口是否在监听，正常应该监听在 17000</p>
<pre><code class="language-shell">ss -tlnp|grep 17000
</code></pre>
<p>启动成功如下图
<img src="cloud_operations/monitor/../../images/n9e/n9e_check_17000.png" alt="avatar" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="夜莺配置-ldap-单点登录"><a class="header" href="#夜莺配置-ldap-单点登录">夜莺配置 ldap 单点登录</a></h1>
<p>夜莺版本 v6.1.0</p>
<p>进入夜莺界面后，在系统配置中，找到单点登录，如下图</p>
<p><img src="cloud_operations/monitor/../../images/n9e/n9e_ldap_config_1.png" alt="avatar" /></p>
<p>选择<code>ldap</code>后，进行相应的修改即可</p>
<p>参考配置如下</p>
<pre><code class="language-conf">Enable = true # 开启
Host = 'ldap_host'
Port = 389
BaseDn = 'dc=n9e,dc=com,dc=cn' # ldap相关配置 仅供参考
BindUser = 'cn=Manager,dc=n9e,dc=com,dc=cn' # ldap 相关配置，仅供参考
BindPass = 'passw0rd'
# openldap format e.g. (&amp;(uid=%s))
# AD format e.g. (&amp;(sAMAccountName=%s))
AuthFilter = '(&amp;(uid=%s))'
CoverAttributes = true
TLS = false
StartTLS = true
DefaultRoles = ['Standard']

[Attributes]
Nickname = 'cn'
Phone = 'mobile'
Email = 'mail'
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prometheus-监控告警-sql"><a class="header" href="#prometheus-监控告警-sql">prometheus 监控告警 sql</a></h1>
<p>这里主要是针对日常用到的监控告警 prom_sql 的记录与描述</p>
<p>版本信息</p>
<blockquote>
<p>prometheus, version 2.19.2</p>
<p>(branch: HEAD, revision: c448ada63d83002e9c1d2c9f84e09f55a61f0ff7)</p>
</blockquote>
<h3 id="一主机相关"><a class="header" href="#一主机相关">一、主机相关</a></h3>
<p>主机存活 sql(node-exporter 服务异常或者服务器宕掉就告警)</p>
<p><code>sql up{app=&quot;node-exporter&quot;,instance=~&quot;192.*&quot;} == 0 </code></p>
<p><strong>注:这里对主机的 ip 进行了相关的筛选，把 instance 里面的匹配值换成自己对应的 ip 网段即可</strong></p>
<p>主机内存告警(内存使用率超过 96 告警)</p>
<pre><code class="language-sql">((node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes) * 100 &gt; 96
</code></pre>
<p>主机 CPU 监控(CPU 使用率超过 90 告警)</p>
<pre><code class="language-sql">100 - ((avg by(instance, job, env) (irate(node_cpu_seconds_total{mode=&quot;idle&quot;}[30s]))) * 100) &gt; 90
</code></pre>
<p>主机网络流量监控(超过 200M 就告警)</p>
<pre><code class="language-sql">avg by(instance, job, env) (irate(node_network_receive_bytes_total{device!=&quot;lo&quot;}[5m]) * 8) / (1000 * 1000) &gt; 200
</code></pre>
<p>主机磁盘监控(超过 90 就告警)</p>
<pre><code class="language-sql">100 - (node_filesystem_avail_bytes{instance=~&quot;172.16.*&quot;} * 100) / node_filesystem_size_bytes{instance=~&quot;172.16.*&quot;} &gt; 90
</code></pre>
<h3 id="二k8s-相关"><a class="header" href="#二k8s-相关">二、k8s 相关</a></h3>
<p>线上 k8s 节点 CPU 监控告警(2 分钟内，CPU 使用率超过 90 就告警)</p>
<pre><code class="language-sql">100 - avg by(instance) (rate(node_cpu_seconds_total{mode=&quot;idle&quot;,instance =~ &quot;172.18.*&quot;}[2m])) * 100 &gt; 90
</code></pre>
<p>注:跟主机 CPU 监控是同一类，单独列出来放到 k8s 里面了</p>
<p>线上 k8s 节点状态监控</p>
<pre><code class="language-sql">kube_node_status_condition{condition=&quot;Ready&quot;,status=&quot;true&quot;, node=~&quot;cn-hangzhou.*&quot;} == 0
</code></pre>
<p>线上 k8s 节点磁盘监控(磁盘使用率超过 90 就告警)</p>
<pre><code class="language-sql">100 - (node_filesystem_avail_bytes{instance=~&quot;172.18.*&quot;} * 100) / node_filesystem_size_bytes{instance=~&quot;172.18.*&quot;} &gt; 90
</code></pre>
<p>注:跟主机 磁盘 监控是同一类，单独列出来放到 k8s 里面了</p>
<p>线上 k8s 节点内存监控告警(内存使用率超过 95 就告警)</p>
<pre><code class="language-sql">100 - node_memory_MemAvailable_bytes{instance =~ &quot;172.18.*&quot;} / node_memory_MemTotal_bytes{instance =~ &quot;172.18.*&quot;} * 100 &gt; 95
</code></pre>
<h3 id="三pod-相关"><a class="header" href="#三pod-相关">三、pod 相关</a></h3>
<p>线上 pod CPU 使用率监控 (5 分钟之内，CPU 使用率超过 80 就告警)</p>
<pre><code class="language-sql">(sum by(name) (rate(container_cpu_usage_seconds_total{image!=&quot;&quot;,namespace=~&quot;moushi-(prod|pre)&quot;}[5m])) * 100) &gt; 80
</code></pre>
<p>线上 pod 内存使用率监控(pod 内存使用率超过 80 就告警)</p>
<pre><code class="language-sql">(sum(container_memory_working_set_bytes{id!=&quot;/&quot;,namespace=~&quot;moushi-(prod|pre)&quot;}) BY (instance,name,container,pod_name,namespace) / sum(container_spec_memory_limit_bytes{id!=&quot;/&quot;,namespace=~&quot;moushi-(prod|pre)&quot;} &gt; 0) BY (instance,name,container,pod_name,namespace) * 100) &gt; 98
</code></pre>
<p>线上 pod 网络流量监控(pod 流入流量 1 分钟之内超过 50M 就告警)</p>
<pre><code class="language-sql">sum by(name) (irate(container_network_receive_bytes_total{container_name=&quot;POD&quot;,namespace=~&quot;moushi-(pre|prod)&quot;}[1m])) &gt; 1024 * 1024 * 50
</code></pre>
<p>pod 启动失败监控(10 分钟之内，启动失败一次就告警)</p>
<pre><code class="language-sql">avg_over_time(kube_pod_container_status_waiting_reason{namespace=~&quot;moushi-(pre|prod)&quot;,reason!=&quot;PodInitializing&quot;, reason!=&quot;ContainerCreating&quot;}[10m]) == 1
</code></pre>
<p>线上 pod 重启监控(5 分钟之内，pod 重启次数超过一次就告警)</p>
<pre><code class="language-sql">increase(kube_pod_container_status_restarts_total{namespace=~&quot;moushi-(prod|pre)&quot;}[5m]) &gt; 0
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="云原生-kubernetes"><a class="header" href="#云原生-kubernetes">云原生 kubernetes</a></h1>
<p>这里主要涉及到<code>kubernetes</code>相关知识已经运维相关的问题!</p>
<ul>
<li><a href="cloud_operations/kubernetes/kubernetes_sa.html">kubernetes sa 相关问题</a></li>
<li><a href="cloud_operations/kubernetes/kubernetes_issues.html">kubernetes 相关问题</a>
<ul>
<li><a href="cloud_operations/kubernetes/kubernetes_issues/k8s_secret_issues.html">kubernetes secret 相关问题</a></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="k8s-sa-相关问题"><a class="header" href="#k8s-sa-相关问题">k8s sa 相关问题</a></h1>
<p>这里主要是记录对 k8s sa 的配置以及其相关运维的问题</p>
<ul>
<li><a href="cloud_operations/kubernetes/kubernetes_sa/k8s_sa_kubeconfig.html">k8s 基于 sa 创建 kubeconfig 访问(集群版)</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="k8s-基于-sa-创建-kubeconfig-访问集群版"><a class="header" href="#k8s-基于-sa-创建-kubeconfig-访问集群版">k8s 基于 sa 创建 kubeconfig 访问（集群版）</a></h1>
<h2 id="1创建-sa"><a class="header" href="#1创建-sa">1、创建 sa</a></h2>
<p>执行以下命令创建 serviceaccount</p>
<pre><code class="language-shell">kubectl create sa devops
</code></pre>
<h2 id="2创建-clusterrole"><a class="header" href="#2创建-clusterrole">2、创建 clusterrole</a></h2>
<p><code>clusterrole.yaml</code></p>
<pre><code class="language-yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  creationTimestamp: '2022-12-11T07:37:26Z'
  name: devops
  resourceVersion: '2468820'
  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterroles/devops
  uid: 21ba0efa-bca7-4a39-868f-f48858ddb591
rules:
  - apiGroups:
      - '*'
    resources:
      - '*'
    verbs:
      - get
      - list
      - watch
      - create
      - delete
      - update
      - patch
</code></pre>
<h2 id="3创建-clusterrolebinding"><a class="header" href="#3创建-clusterrolebinding">3、创建 clusterrolebinding</a></h2>
<p><code>clusterrolebinding.yaml</code></p>
<pre><code class="language-yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: devops
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: devops
subjects:
  - kind: ServiceAccount
    name: devops
    namespace: default
</code></pre>
<h2 id="4生成-kubeconfig"><a class="header" href="#4生成-kubeconfig">4、生成 kubeconfig</a></h2>
<p>假设 k8s 的 apiserver 地址为：<strong><a href="https://192.168.1.236:16443">https://192.168.1.236:16443</a></strong></p>
<p>假设 k8s 集群的 ca 证书文件目录为：<strong>/etc/kubernetes/pki/ca.pem</strong></p>
<h3 id="41-获取-sa-token"><a class="header" href="#41-获取-sa-token">4.1 获取 sa token</a></h3>
<pre><code class="language-shell">kubectl get secret $(kubectl get secret -A | grep devops | awk '{print $2}') -o=jsonpath='{.data.token}' | base64 -d
</code></pre>
<h3 id="42-生成-kubeconfig-步骤"><a class="header" href="#42-生成-kubeconfig-步骤">4.2 生成 kubeconfig 步骤</a></h3>
<pre><code class="language-shell">KUBE_APISERVER=https://192.168.1.236:16443
DEVOPS_TOKEN=`kubectl get secret $(kubectl get secret -A | grep devops | awk '{print $2}') -o=jsonpath='{.data.token}' | base64 -d` # 这里为上一步获取token的命令

# 设置集群信息
kubectl config set-cluster kubernetes \ # kubernetes是集群名字
--certificate-authority=/etc/kubernetes/pki/ca.pem \ # 这个ca是k8s集群的ca证书
--embed-certs=true \
--server=${KUBE_APISERVER} \ # 这个是api-server的连接地址，通过kubectl cluster-info能看到
--kubeconfig=devops.kubeconfig

# 设置客户端认证凭据
kubectl config set-credentials devops-user \ # devops-user表示凭据的用户名
--token=${DEVOPS_TOKEN} \ # token可通过第一个步骤中得到
--kubeconfig=devops.kubeconfig

# 设置集群信息和用户的上下文信息
kubectl config set-context devops@kubernetes \ # 设置上下文名字
--cluster=kubernetes \ # kubernetes集群名字，跟设置集群信息中保持一致
--user=devops-user \ # 第二步设置凭据的用户名
--kubeconfig=devops.kubeconfig

# 切换当前上下文
kubectl config use-context devops@kubernetes \
--kubeconfig=./devops.kubeconfig
</code></pre>
<h2 id="5命令测试"><a class="header" href="#5命令测试">5、命令测试</a></h2>
<pre><code class="language-shell">kubectl --kubeconfig=./devops.kubeconfig get pod -A
</code></pre>
<h2 id="6使用"><a class="header" href="#6使用">6、使用</a></h2>
<p>将生成的<code>devops.config</code>放到 用户家目录下的<code>.kube</code>文件下，并重命名为<code>config</code>即可，例如</p>
<pre><code class="language-shell">mkdir ~/.kube

mv devops.config ~/.kube/config
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="k8s-相关问题"><a class="header" href="#k8s-相关问题">k8s 相关问题</a></h1>
<p>这里主要是记录对 k8s 版本之间的配置以及其相关运维的问题</p>
<p><a href="cloud_operations/kubernetes/kubernetes_issues/k8s_secret_issues.html">kubernetes secret 相关问题</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="k8s-新版本问题处理"><a class="header" href="#k8s-新版本问题处理">k8s 新版本问题处理</a></h1>
<h4 id="1创建-sa-不会自动生成相应-secret-问题"><a class="header" href="#1创建-sa-不会自动生成相应-secret-问题">1、创建 sa 不会自动生成相应 secret 问题</a></h4>
<blockquote>
<p>k8s serviceaccount 创建后没有生成对应的 secret</p>
</blockquote>
<p>👉🏻<a href="https://www.soulchild.cn/post/2945">参考文章: k8s serviceaccount 创建后没有生成对应的 secret</a></p>
<p>👉🏻<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.24.md#urgent-upgrade-notes">changelog 在这里</a></p>
<p>👉🏻<a href="https://github.com/kubernetes/kubernetes/pull/108309">相关 pr</a></p>
<p>方法如下</p>
<p>方式 1 使用 TokenRequest API 来生成 token，获取方式如下</p>
<ul>
<li>使用 client-go 或者其他 api 调用工具来获取某个 serviceaccount 的 token</li>
<li>创建 yaml，使用 kubectl apply -f</li>
<li>使用 kubectl create token -n xxx <serviceaccount-name> 来获取一个临时的 token, 默认 1 小时</li>
</ul>
<p>方式 2 创建 secret token，创建后从 secret 的 token 字段拿就可以了</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Secret
metadata:
  name: secret-sa-sample
  annotations:
    kubernetes.io/service-account.name: 'sa-name' # 这里填写serviceAccountName
type: kubernetes.io/service-account-token
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="language.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
