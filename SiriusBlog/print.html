<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js navy">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Sirius运维开发笔记</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="Sirius运维开发笔记">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> 简介</a></li><li class="chapter-item expanded "><a href="operations.html"><strong aria-hidden="true">2.</strong> 基础运维</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="operations/linux.html"><strong aria-hidden="true">2.1.</strong> linux</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="operations/linux/linux_base_config.html"><strong aria-hidden="true">2.1.1.</strong> linux 基础配置</a></li><li class="chapter-item expanded "><a href="operations/linux/linux_kernel_upgrade_online.html"><strong aria-hidden="true">2.1.2.</strong> linux 内核升级(线上)</a></li><li class="chapter-item expanded "><a href="operations/linux/linux_kernel_upgrade_offline.html"><strong aria-hidden="true">2.1.3.</strong> linux 内核升级(离线)</a></li><li class="chapter-item expanded "><a href="operations/linux/linux_supervisor_install.html"><strong aria-hidden="true">2.1.4.</strong> supervisord 安装配置</a></li><li class="chapter-item expanded "><a href="operations/linux/linux_ops_issues.html"><strong aria-hidden="true">2.1.5.</strong> linux 运维问题排查</a></li></ol></li><li class="chapter-item expanded "><a href="operations/docker.html"><strong aria-hidden="true">2.2.</strong> docker</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="operations/docker/linux_docker_installed.html"><strong aria-hidden="true">2.2.1.</strong> docker 安装与配置</a></li><li class="chapter-item expanded "><a href="operations/docker/linux_docker_compose_installed.html"><strong aria-hidden="true">2.2.2.</strong> docker-compose 安装</a></li><li class="chapter-item expanded "><a href="operations/docker/linux_docker_issues.html"><strong aria-hidden="true">2.2.3.</strong> docker 相关问题</a></li></ol></li><li class="chapter-item expanded "><a href="operations/redis.html"><strong aria-hidden="true">2.3.</strong> redis</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="operations/redis/redis_binary_installed.html"><strong aria-hidden="true">2.3.1.</strong> redis 二进制安装与配置</a></li><li class="chapter-item expanded "><a href="operations/redis/redis_docker_installed.html"><strong aria-hidden="true">2.3.2.</strong> redis docker-compose 安装与配置</a></li></ol></li><li class="chapter-item expanded "><a href="operations/mongodb.html"><strong aria-hidden="true">2.4.</strong> mongodb</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="operations/mongodb/mongodb_docker_installed.html"><strong aria-hidden="true">2.4.1.</strong> mongodb docker-compose 安装与配置</a></li></ol></li><li class="chapter-item expanded "><a href="operations/elasticsearch.html"><strong aria-hidden="true">2.5.</strong> elasticsearch</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="operations/elasticsearch/es_docker_installed.html"><strong aria-hidden="true">2.5.1.</strong> elasticsearch docker-compose 安装与配置(7.10.0 版本)</a></li><li class="chapter-item expanded "><a href="operations/elasticsearch/es_ik_installed.html"><strong aria-hidden="true">2.5.2.</strong> elasticsearch ik 分词器安装(7.10.0 版本)</a></li></ol></li><li class="chapter-item expanded "><a href="operations/git.html"><strong aria-hidden="true">2.6.</strong> git</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="operations/git/git_operation.html"><strong aria-hidden="true">2.6.1.</strong> git 版本控制</a></li><li class="chapter-item expanded "><a href="operations/git/git_clone_without_pass.html"><strong aria-hidden="true">2.6.2.</strong> git http 方式免密克隆代码</a></li><li class="chapter-item expanded "><a href="operations/git/git_dev_specification.html"><strong aria-hidden="true">2.6.3.</strong> git 开发管理规范</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="cloud_operations.html"><strong aria-hidden="true">3.</strong> 云原生</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cloud_operations/monitor.html"><strong aria-hidden="true">3.1.</strong> 监控</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cloud_operations/monitor/n9e_install.html"><strong aria-hidden="true">3.1.1.</strong> 夜莺监控安装配置</a></li><li class="chapter-item expanded "><a href="cloud_operations/monitor/n9e_ldap_config.html"><strong aria-hidden="true">3.1.2.</strong> 夜莺配置 ldap 单点登录</a></li><li class="chapter-item expanded "><a href="cloud_operations/monitor/alert_prom_sql.html"><strong aria-hidden="true">3.1.3.</strong> prometheus 监控告警 sql</a></li><li class="chapter-item expanded "><a href="cloud_operations/monitor/prometheus_domain_monitor.html"><strong aria-hidden="true">3.1.4.</strong> prometheus 监控域名</a></li></ol></li><li class="chapter-item expanded "><a href="cloud_operations/kubernetes.html"><strong aria-hidden="true">3.2.</strong> kubernetes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cloud_operations/kubernetes/kubernetes_sa.html"><strong aria-hidden="true">3.2.1.</strong> kubernetes service account</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cloud_operations/kubernetes/kubernetes_sa/k8s_sa_kubeconfig.html"><strong aria-hidden="true">3.2.1.1.</strong> kubernetees 基于 sa 创建 kubeconfig 访问(集群版)</a></li></ol></li><li class="chapter-item expanded "><a href="cloud_operations/kubernetes/kubernetes_issues.html"><strong aria-hidden="true">3.2.2.</strong> k8s 相关问题</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cloud_operations/kubernetes/kubernetes_issues/k8s_secret_issues.html"><strong aria-hidden="true">3.2.2.1.</strong> kubernetes secret 相关问题</a></li></ol></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Sirius运维开发笔记</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/einsli/SiriusBlog" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="sirius-运维笔记"><a class="header" href="#sirius-运维笔记">Sirius 运维笔记</a></h1>
<blockquote>
<p>运维开发攻城狮一枚，目前在杭州，主要做 CICD, K8S 运维相关,技术宅！</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="基础运维"><a class="header" href="#基础运维">基础运维</a></h1>
<p>这里主要是基础运维，涉及到基础环境搭建以及配置.</p>
<ul>
<li>
<p><a href="operations/linux.html">linux</a></p>
</li>
<li>
<p><a href="operations/docker.html">docker</a></p>
</li>
<li>
<p><a href="operations/redis.html">redis</a></p>
</li>
<li>
<p><a href="operations/git.html">git</a></p>
</li>
<li>
<p><a href="operations/mongodb.html">mongodb</a></p>
</li>
<li>
<p><a href="operations/elasticsearch.html">elasticsearch</a></p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-基础运维"><a class="header" href="#linux-基础运维">linux 基础运维</a></h1>
<p>这里主要是 linux 基础运维，涉及到 linux 基础环境搭建以及配置和相关问题的处理.</p>
<ul>
<li>
<p><a href="operations/linux/linux_base_config.html">linux 基础配置</a></p>
</li>
<li>
<p><a href="operations/linux/linux_kernel_upgrade_online.html">linux 内核升级(线上)</a></p>
</li>
<li>
<p><a href="operations/linux/linux_kernel_upgrade_offline.html">linux 内核升级(离线)</a></p>
</li>
<li>
<p><a href="operations/linux/linux_supervisor_install.html">supervisord 安装配置</a></p>
</li>
<li>
<p><a href="operations/linux/linux_ops_issues.html">linux 运维问题排查</a></p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-基础配置"><a class="header" href="#linux-基础配置">linux 基础配置</a></h1>
<h2 id="一务器系统配置初始化脚本"><a class="header" href="#一务器系统配置初始化脚本">一、务器系统配置初始化脚本</a></h2>
<p>当拿到一台 linux 服务器，需要对 linux 做一些操作，来保证后续部署的服务能够高效稳定的运行。</p>
<h3 id="11-关闭-swap-分区"><a class="header" href="#11-关闭-swap-分区">1.1 关闭 swap 分区</a></h3>
<p><strong>临时关闭</strong></p>
<pre><code class="language-shell">swapoff -a
</code></pre>
<p><strong>永久关闭</strong></p>
<p>打开文件<code>/etc/fstab</code></p>
<pre><code class="language-shell">vim /etc/fstab
</code></pre>
<p>找到<code>swap</code>分区将其注释掉即可</p>
<pre><code class="language-PlainText">#/dev/mapper/cl-swap     swap                    swap    defaults        0 0
</code></pre>
<p><strong>重启机器</strong></p>
<pre><code class="language-shell">reboot
</code></pre>
<h3 id="12-关闭-selinux"><a class="header" href="#12-关闭-selinux">1.2 关闭 selinux</a></h3>
<p><strong>查看 selinux 状态</strong></p>
<pre><code class="language-shell">getenforce
</code></pre>
<p><img src="operations/linux/../../images/operations/linux/enable_selinux.png" alt="avar" /></p>
<p><strong>临时关闭</strong></p>
<pre><code class="language-shell">setenforce 0
</code></pre>
<p>重启系统后还会开启</p>
<p><strong>永久关闭</strong></p>
<pre><code class="language-shell">sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux
</code></pre>
<p><strong>重启机器</strong></p>
<pre><code class="language-shell">reboot
</code></pre>
<p><strong>关闭后查看 selinux 状态</strong></p>
<pre><code class="language-shell">getenforce
</code></pre>
<p><img src="operations/linux/../../images/operations/linux/disable_selinux.png" alt="avar" /></p>
<h3 id="13-关闭防火墙"><a class="header" href="#13-关闭防火墙">1.3 关闭防火墙</a></h3>
<p>关闭防火墙命令如下</p>
<pre><code class="language-shell">systemctl stop firewalld &amp;&amp; systemctl disable firewalld
</code></pre>
<h3 id="14-主机名配置"><a class="header" href="#14-主机名配置">1.4 主机名配置</a></h3>
<p>拿到主机后，需要给服务器配置一个主机名，就像每个人有自己的名字一样</p>
<p>配置主机名命令如下</p>
<pre><code class="language-shell">hostnamectl --static set-hostname sirius
</code></pre>
<h3 id="15-ssh-配置"><a class="header" href="#15-ssh-配置">1.5 ssh 配置</a></h3>
<p><strong>关闭 DNS 反查</strong>
使用了 dns 反查，这种情况下当 ssh 登录某个 IP 时，系统会试图通过 DNS 反查相对应的域名，如果 DNS 中没有这个 IP 的域名解析，则会等到 DNS 查询超时才会进行下一步，消耗很长时间。</p>
<p>关闭 dns 反查命令如下</p>
<pre><code class="language-shell">sed -ie &quot;/UseDNS/s/yes/no/g;/UseDNS/s/#//g&quot; /etc/ssh/sshd_config
</code></pre>
<p><strong>修改 ssh 超时时间</strong></p>
<pre><code class="language-shell">vim /etc/ssh/sshd_config
</code></pre>
<p>修改下面两项</p>
<pre><code class="language-PlainText">ClientAliveInterval 60
ClientAliveCountMax 30
</code></pre>
<p><strong>重启 ssh 服务</strong></p>
<pre><code class="language-shell">systemctl restart sshd
</code></pre>
<h3 id="16-修改系统时区"><a class="header" href="#16-修改系统时区">1.6 修改系统时区</a></h3>
<p>查看系统时区是否正常</p>
<p><img src="operations/linux/../../images/operations/linux/shanghai_timezone.png" alt="avar" /></p>
<p>上述图片是已经修改正常状态</p>
<p>修改系统时间命令如下</p>
<pre><code class="language-shell">mv /etc/localtime /etc/localtime.bak
-s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</code></pre>
<p>然后输入上图命令即可验证时间即可</p>
<h4 id="参考文档"><a class="header" href="#参考文档">参考文档</a></h4>
<ul>
<li><a href="http://bluebiu.com/blog/linux-ssh-session-alive.html">Linux 使用 ssh 超时断开连接的真正原因</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-内核升级"><a class="header" href="#linux-内核升级">linux 内核升级</a></h1>
<h2 id="一在线升级"><a class="header" href="#一在线升级">一、在线升级</a></h2>
<p>本升级方法适用于所有 Centos7.x 系列的 OS</p>
<h3 id="11-查看当前内核版本"><a class="header" href="#11-查看当前内核版本">1.1 查看当前内核版本</a></h3>
<pre><code class="language-shell">$ uname -r
3.10.0-514.el7.x86_64

$ uname -a
Linux hecs-133409 4.18.0-240.10.1.el8_3.x86_64 #1 SMP Mon Jan 18 17:05:51 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux

$ cat /etc/redhat-release
CentOS Linux release 7.3.1611 (Core)
</code></pre>
<h3 id="22-升级内核"><a class="header" href="#22-升级内核">2.2 升级内核</a></h3>
<h4 id="221-更新-yum-仓库"><a class="header" href="#221-更新-yum-仓库">2.2.1 更新 yum 仓库</a></h4>
<pre><code class="language-shell">yum update
</code></pre>
<h4 id="222-启用-elrepo-仓库"><a class="header" href="#222-启用-elrepo-仓库">2.2.2 启用 ELRepo 仓库</a></h4>
<p>ELRepo 仓库是基于社区的用于企业级 Linux 仓库，提供对 RedHat Enterprise (RHEL) 和 其他基于 RHEL 的 Linux 发行版（CentOS、Scientific、Fedora 等）的支持。
ELRepo 聚焦于和硬件相关的软件包，包括文件系统驱动、显卡驱动、网络驱动、声卡驱动和摄像头驱动等。</p>
<h4 id="1-导入-elrepo-仓库的公共密钥"><a class="header" href="#1-导入-elrepo-仓库的公共密钥">(1) 导入 ELRepo 仓库的公共密钥</a></h4>
<pre><code class="language-shell">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
</code></pre>
<h4 id="2-安装-elrepo-仓库的-yum-源"><a class="header" href="#2-安装-elrepo-仓库的-yum-源">(2) 安装 ELRepo 仓库的 yum 源</a></h4>
<pre><code class="language-shell">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm
</code></pre>
<h4 id="3-查看可用的系统内核包"><a class="header" href="#3-查看可用的系统内核包">(3) 查看可用的系统内核包</a></h4>
<pre><code class="language-shell">yum --disablerepo=&quot;*&quot; --enablerepo=&quot;elrepo-kernel&quot; list available
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
* elrepo-kernel: mirrors.tuna.tsinghua.edu.cn
  elrepo-kernel                                                                         | 2.9 kB  00:00:00
  elrepo-kernel/primary_db                                                              | 1.8 MB  00:00:03
  Available Packages
  kernel-lt.x86_64                                   4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-lt-devel.x86_64                             4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-lt-doc.noarch                               4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-lt-headers.x86_64                           4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-lt-tools.x86_64                             4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-lt-tools-libs.x86_64                        4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-lt-tools-libs-devel.x86_64                  4.4.155-1.el7.elrepo                    elrepo-kernel
  kernel-ml.x86_64                                   4.18.7-1.el7.elrepo                     elrepo-kernel
  kernel-ml-devel.x86_64                             4.18.7-1.el7.elrepo                     elrepo-kernel
  kernel-ml-doc.noarch                               4.18.7-1.el7.elrepo                     elrepo-kernel
  kernel-ml-headers.x86_64                           4.18.7-1.el7.elrepo                     elrepo-kernel
  kernel-ml-tools.x86_64                             4.18.7-1.el7.elrepo                     elrepo-kernel
  kernel-ml-tools-libs.x86_64                        4.18.7-1.el7.elrepo                     elrepo-kernel
  kernel-ml-tools-libs-devel.x86_64                  4.18.7-1.el7.elrepo                     elrepo-kernel
  perf.x86_64                                        4.18.7-1.el7.elrepo                     elrepo-kernel
  python-perf.x86_64                                  4.18.7-1.el7.elrepo                    elrepo-kernel
</code></pre>
<h4 id="4-安装最新版本内核"><a class="header" href="#4-安装最新版本内核">(4) 安装最新版本内核</a></h4>
<pre><code class="language-shell">yum --enablerepo=elrepo-kernel install kernel-ml
</code></pre>
<p><font color='red'><strong>--enablerepo</strong></font> 选项开启 CentOS 系统上的指定仓库。默认开启的是<font color='red'><strong>elrepo</strong></font>，这里用 <font color='red'><strong>-kernel</strong></font> 替换</p>
<h4 id="5-设置-grub2"><a class="header" href="#5-设置-grub2">(5) 设置 grub2</a></h4>
<p>内核安装好后，需要设置为默认启动选项并重启后才会生效</p>
<p>1、 查看系统上的所有可用内核</p>
<pre><code class="language-shell">awk -F\' '$1==&quot;menuentry &quot; {print i++ &quot; : &quot; $2}' /etc/grub2.cfg
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">0 : CentOS Linux (4.18.7-1.el7.elrepo.x86_64) 7 (Core)
1 : CentOS Linux (3.10.0-862.11.6.el7.x86_64) 7 (Core)
2 : CentOS Linux (3.10.0-514.el7.x86_64) 7 (Core)
3 : CentOS Linux (0-rescue-063ec330caa04d4baae54c6902c62e54) 7 (Core)
</code></pre>
<p>2、设置新的内核为 grub2 的默认版本</p>
<p>服务器上存在 4 个内核，我们要使用 4.18 这个版本，可以通过 grub2-set-default 0 命令或编辑 /etc/default/grub 文件来设置</p>
<p>方法一、通过 <font color='red'><strong>grub2-set-default 0</strong></font> 命令设置</p>
<p>其中 0 是上面查询出来的可用内核</p>
<pre><code class="language-shell">grub2-set-default 0
</code></pre>
<p>方法二、编辑 <font color='red'><strong>/etc/default/grub</strong></font> 文件
设置 GRUB_DEFAULT=0，通过上面查询显示的编号为 0 的内核作为默认内核</p>
<pre><code class="language-shell">vim /etc/default/grub
</code></pre>
<pre><code class="language-PlainText">GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR=&quot;$(sed 's, release .*$,,g' /etc/system-release)&quot;
GRUB_DEFAULT=0
GRUB_DISABLE_SUBMENU=true
GRUB_TERMINAL_OUTPUT=&quot;console&quot;
GRUB_CMDLINE_LINUX=&quot;crashkernel=auto rd.lvm.lv=cl/root rhgb quiet&quot;
GRUB_DISABLE_RECOVERY=&quot;true&quot;
</code></pre>
<p>3、生成 grub 配置文件并重启</p>
<pre><code class="language-shell">grub2-mkconfig -o /boot/grub2/grub.cfg
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">Generating grub configuration file ...
Found linux image: /boot/vmlinuz-4.18.7-1.el7.elrepo.x86_64
Found initrd image: /boot/initramfs-4.18.7-1.el7.elrepo.x86_64.img
Found linux image: /boot/vmlinuz-3.10.0-862.11.6.el7.x86_64
Found initrd image: /boot/initramfs-3.10.0-862.11.6.el7.x86_64.img
Found linux image: /boot/vmlinuz-3.10.0-514.el7.x86_64
Found initrd image: /boot/initramfs-3.10.0-514.el7.x86_64.img
Found linux image: /boot/vmlinuz-0-rescue-063ec330caa04d4baae54c6902c62e54
Found initrd image: /boot/initramfs-0-rescue-063ec330caa04d4baae54c6902c62e54.img
done
</code></pre>
<p>重启</p>
<pre><code class="language-shell">reboot
</code></pre>
<p>4、验证</p>
<pre><code class="language-shell">uname -r
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">4.18.7-1.el7.elrepo.x86_64
</code></pre>
<h3 id="23-删除旧的内核可选"><a class="header" href="#23-删除旧的内核可选">2.3 删除旧的内核（可选）</a></h3>
<h4 id="231-查看系统中全部的内核"><a class="header" href="#231-查看系统中全部的内核">2.3.1 查看系统中全部的内核</a></h4>
<pre><code class="language-shell">rpm -qa | grep kernel
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">kernel-3.10.0-514.el7.x86_64
kernel-ml-4.18.7-1.el7.elrepo.x86_64
kernel-tools-libs-3.10.0-862.11.6.el7.x86_64
kernel-tools-3.10.0-862.11.6.el7.x86_64
kernel-3.10.0-862.11.6.el7.x86_64
</code></pre>
<h4 id="232-删除内核"><a class="header" href="#232-删除内核">2.3.2 删除内核</a></h4>
<p>方法一 通过 <font color='red'><strong>yum remove</strong></font>删除</p>
<pre><code class="language-shell">yum remove kernel-3.10.0-514.el7.x86_64 \
kernel-ml-4.18.7-1.el7.elrepo.x86_64 \
kernel-tools-libs-3.10.0-862.11.6.el7.x86_64 \
kernel-tools-3.10.0-862.11.6.el7.x86_64 \
kernel-3.10.0-862.11.6.el7.x86_64
</code></pre>
<p>方法二：使用 <font color='red'><strong>yum-utils</strong></font>工具删除</p>
<p>如果安装的内核不多于 3 个，<font color='red'><strong>yum-utils</strong></font> 工具不会删除任何一个。只有在安装的内核大于 3 个时，才会自动删除旧内核。</p>
<p>安装 yum-utils</p>
<pre><code class="language-shell">yum install yum-utils
</code></pre>
<p>删除旧版本</p>
<pre><code class="language-shell">package-cleanup --oldkernels
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="离线升级"><a class="header" href="#离线升级">离线升级</a></h1>
<h2 id="一获取离线升级包"><a class="header" href="#一获取离线升级包">一、获取离线升级包</a></h2>
<p>到<a href="https://elrepo.org/linux/kernel/el7/x86_64/RPMS/">elrepo</a>的网站下载想要的版本</p>
<pre><code class="language-shell">wget https://elrepo.org/linux/kernel/el7/x86_64/RPMS/kernel-ml-5.16.10-1.el7.elrepo.x86_64.rpm
wget https://elrepo.org/linux/kernel/el7/x86_64/RPMS/kernel-ml-devel-5.16.10-1.el7.elrepo.x86_64.rpm
</code></pre>
<p>::: warning 注意
如果在目标服务器无法上网情况下也可在自己电脑下载 rpm 包，然后上传到服务器
:::</p>
<h2 id="二升级内核"><a class="header" href="#二升级内核">二、升级内核</a></h2>
<h3 id="21-安装-rpm-包"><a class="header" href="#21-安装-rpm-包">2.1 安装 rpm 包</a></h3>
<pre><code class="language-shell">yum localinstall -y kernel-lt-4.4.206-1.el7.elrepo.x86_64.rpm \
kernel-lt-devel-4.4.206-1.el7.elrepo.x86_64.rpm
</code></pre>
<h3 id="22-查看系统上的所有可用内核"><a class="header" href="#22-查看系统上的所有可用内核">2.2 查看系统上的所有可用内核</a></h3>
<pre><code class="language-shell">awk -F\' '$1==&quot;menuentry &quot; {print i++ &quot; : &quot; $2}' /etc/grub2.cfg
</code></pre>
<pre><code class="language-text">0 : CentOS Linux (5.16.10-1.el7.elrepo.x86_64) 7 (Core)
1 : CentOS Linux (3.10.0-862.11.6.el7.x86_64) 7 (Core)
2 : CentOS Linux (3.10.0-514.el7.x86_64) 7 (Core)
3 : CentOS Linux (0-rescue-063ec330caa04d4baae54c6902c62e54) 7 (Core)
</code></pre>
<p>设置新的内核为 grub2 的默认版本
服务器上存在 4 个内核，我们要使用 5.16 这个版本，可以通过 grub2-set-default 0 命令或编辑 /etc/default/grub 文件来设置</p>
<h4 id="221-通过-grub2-set-default-0-命令设置"><a class="header" href="#221-通过-grub2-set-default-0-命令设置">2.2.1 通过 <font color='red'><strong>grub2-set-default 0</strong></font> 命令设置</a></h4>
<p>其中 0 是上面查询出来的可用内核</p>
<pre><code class="language-shell">grub2-set-default 0
</code></pre>
<h4 id="222-方法-2编辑-etcdefaultgrub-文件"><a class="header" href="#222-方法-2编辑-etcdefaultgrub-文件">2.2.2 方法 2、编辑 <font color='red'><strong>/etc/default/grub</strong></font> 文件</a></h4>
<p>设置 GRUB_DEFAULT=0，通过上面查询显示的编号为 0 的内核作为默认内核：</p>
<pre><code class="language-shell">vim /etc/default/grub
</code></pre>
<pre><code class="language-text">GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR=&quot;$(sed 's, release .*$,,g' /etc/system-release)&quot;
GRUB_DEFAULT=0
GRUB_DISABLE_SUBMENU=true
GRUB_TERMINAL_OUTPUT=&quot;console&quot;
GRUB_CMDLINE_LINUX=&quot;crashkernel=auto rd.lvm.lv=cl/root rhgb quiet&quot;
GRUB_DISABLE_RECOVERY=&quot;true&quot;
</code></pre>
<h3 id="23-生成-grub-配置文件并重启"><a class="header" href="#23-生成-grub-配置文件并重启">2.3 生成 grub 配置文件并重启</a></h3>
<pre><code class="language-shell">grub2-mkconfig -o /boot/grub2/grub.cfg
</code></pre>
<pre><code class="language-text">Generating grub configuration file ...
Found linux image: /boot/vmlinuz-5.16.10-1.el7.elrepo.x86_64
Found initrd image: /boot/initramfs-5.16.10-1.el7.elrepo.x86_64.img
Found linux image: /boot/vmlinuz-3.10.0-862.11.6.el7.x86_64
Found initrd image: /boot/initramfs-3.10.0-862.11.6.el7.x86_64.img
Found linux image: /boot/vmlinuz-3.10.0-514.el7.x86_64
Found initrd image: /boot/initramfs-3.10.0-514.el7.x86_64.img
Found linux image: /boot/vmlinuz-0-rescue-063ec330caa04d4baae54c6902c62e54
Found initrd image: /boot/initramfs-0-rescue-063ec330caa04d4baae54c6902c62e54.img
done
</code></pre>
<pre><code class="language-shell">reboot
</code></pre>
<h2 id="24-验证"><a class="header" href="#24-验证">2.4 验证</a></h2>
<pre><code class="language-shell">uname -r
</code></pre>
<pre><code class="language-text">5.16.10-1.el7.elrepo.x86_64
</code></pre>
<h2 id="25-删除旧的内核可选"><a class="header" href="#25-删除旧的内核可选">2.5 删除旧的内核（可选）</a></h2>
<h3 id="251-查看系统中全部的内核"><a class="header" href="#251-查看系统中全部的内核">2.5.1 查看系统中全部的内核</a></h3>
<pre><code class="language-shell">rpm -qa | grep kernel
</code></pre>
<pre><code class="language-text">kernel-3.10.0-514.el7.x86_64
kernel-ml-5.16.10-1.el7.elrepo.x86_64
kernel-tools-libs-3.10.0-862.11.6.el7.x86_64
kernel-tools-3.10.0-862.11.6.el7.x86_64
kernel-3.10.0-862.11.6.el7.x86_64
</code></pre>
<h4 id="方法一通过-yum-remove删除"><a class="header" href="#方法一通过-yum-remove删除">方法一：通过 <font color='red'><strong>yum remove</strong></font>删除</a></h4>
<pre><code class="language-shell">yum remove kernel-3.10.0-514.el7.x86_64 \
kernel-tools-libs-3.10.0-862.11.6.el7.x86_64 \
kernel-tools-3.10.0-862.11.6.el7.x86_64 \
kernel-3.10.0-862.11.6.el7.x86_64
</code></pre>
<h4 id="方法二使用-yum-utils工具删除"><a class="header" href="#方法二使用-yum-utils工具删除">方法二：使用 <font color='red'><strong>yum-utils</strong></font>工具删除</a></h4>
<p>如果安装的内核不多于 3 个，<font color='red'><strong>yum-utils</strong></font> 工具不会删除任何一个。只有在安装的内核大于 3 个时，才会自动删除旧内核。</p>
<p>安装<font color='red'><strong>yum-utils</strong></font></p>
<pre><code class="language-shell">yum install yum-utils
</code></pre>
<p>删除旧版本</p>
<pre><code class="language-shell">package-cleanup --oldkernels
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="supervisor-安装与配置"><a class="header" href="#supervisor-安装与配置">supervisor 安装与配置</a></h1>
<p>执行以下命令安装 supervisord</p>
<pre><code class="language-shell">yum install supervisor
</code></pre>
<p>查看版本</p>
<pre><code class="language-shell">supervisord --version
</code></pre>
<p>如果需要配置界面访问需要修改<code>supervisord.conf</code></p>
<p>路径如下</p>
<pre><code class="language-PlainText">/etc/supervisord.conf
</code></pre>
<p>修改以下几行</p>
<pre><code class="language-PlainText">#启用访问web控制界面，inet_http_server 修改如下
[inet_http_server]
port=*:9001

#设置账户和密码
username=user
password=passw0rd

#include part
[include]
files = supervisord.d/*.ini
</code></pre>
<p>子进程配置文件路径：<code>/etc/supervisord.d/</code></p>
<p>这是官网的配置文件 👉🏻<a href="http://www.supervisord.org/configuration.html">supervisord 配置文件参考</a></p>
<p>在<code>/etc/supervisord.d/</code> 创建<code>test-server.ini</code>,用于启动一个<code>java</code>服务</p>
<pre><code class="language-ini">[program:javaserver]
command=/usr/bin/java -jar app.jar ; 输入执行命令，这里表示 dotnet  demo.dll
directory=/opt/test-server ; 应用程序根目录
autostart=true ; 是否自动启动，当 supervisor 加载该配置文件的时候立即启动它
autorestart=true ; 是否自动重启，当执行 dotnet  Deploy.Linux.dll 启动失败时，会重复的自动重启
logfile_maxbytes=50MB ; 该配置文件输出单个日志文件的大小
logfile_backups=10 ; 日志备份个数
loglevel=info ; 记录日志级别
stderr_logfile=/data/logs/java-server.err.log ; 指定标准错误输出日志文件
stdout_logfile=/data/logs/java-server.access.log ; 指定标准输出日志文件
environment=ASPNETCORE_ENVIRONMENT=Production ; 可配置环境变量，该环境变量将通过执行 dotnet  Deploy.Linux.dll 命令的时候传入到 .NET Core 应用程序中
user=root ;启动服务的用户
stopsignal=INT
redirect_stderr=true
</code></pre>
<p>创建日志路径</p>
<pre><code class="language-shell">mkdir -p /data/logs/
</code></pre>
<p>重新加载配置</p>
<pre><code class="language-shell">systemctl daemon-reload
</code></pre>
<p>启动<code>supervisord</code>并设置为开机启动</p>
<pre><code class="language-shell"># 启动supervisord
systemctl start supervisord

# 设置开机启动
systemctl enable supervisord

# 查看supervisord 状态
systemctl status supervisord
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-运维问题排查"><a class="header" href="#linux-运维问题排查">linux 运维问题排查</a></h1>
<h2 id="11-内存占用高的问题"><a class="header" href="#11-内存占用高的问题">1.1 内存占用高的问题</a></h2>
<p><strong>top</strong>
排查内存占用高的进程，用<code>top</code> 命令，然后<code>shift + m</code> 显示占用内存最多的进程在最上方</p>
<p><strong>ps</strong></p>
<p>输入以下命令，即可对内存占用比较高的进行逆序排序</p>
<pre><code class="language-shell">ps aux --sort -rss | head -n 10
</code></pre>
<p>说明:
ps aux 用于列出所有进程的详细信息，<code>--sort -rss`` 表示按照内存占用逆序排序，</code>head -n 10` 表示只显示前 10 行结果</p>
<p><strong>htop</strong></p>
<p><code>htop`` 是一个交互式的进程查看器，可以直观地显示系统的各项指标。在终端中输入</code>htop`` 命令后，按下<code>F6</code>键可以选择按照内存占用排序，然后可以看到内存占用最高的进程在最上方。</p>
<h2 id="12-排查问题是过滤点配置文件中的注释和换行"><a class="header" href="#12-排查问题是过滤点配置文件中的注释和换行">1.2 排查问题是，过滤点配置文件中的注释和换行</a></h2>
<p>可以使用<code>grep -vE '^\s*(#|$)'</code> 来操作</p>
<pre><code class="language-shell">grep -vE '^\s*(#|$)' your_file
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker-基础运维"><a class="header" href="#docker-基础运维">docker 基础运维</a></h1>
<p>这里主要是 docker 基础运维，涉及到 docker 基础环境搭建以及配置和相关问题的处理.</p>
<ul>
<li>
<p><a href="operations/docker/linux_docker_installed.html">docker 安装与配置</a></p>
</li>
<li>
<p><a href="operations/docker/linux_docker_compose_installed.html">linux docker-compose 安装</a></p>
</li>
<li>
<p><a href="operations/docker/linux_docker_issues.html">docker 相关问题</a></p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-docker-安装与配置"><a class="header" href="#linux-docker-安装与配置">linux docker 安装与配置</a></h1>
<h2 id="一docker-离线安装"><a class="header" href="#一docker-离线安装">一、docker 离线安装</a></h2>
<h3 id="11下载离线安装包"><a class="header" href="#11下载离线安装包">1.1、下载离线安装包</a></h3>
<blockquote>
<p>访问地址: <a href="https://download.docker.com/linux/static/stable/x86_64/">docker 离线下载地址</a></p>
<p>选择对应版本,此处选择<code>docker-20-10.8.tgz</code></p>
</blockquote>
<p><img src="operations/docker/../../images/operations/docker/docker_version_selected.png" alt="avatar" /></p>
<p>可以下载到本地后上传至服务器，或者在服务器执行以下命令直接下载</p>
<pre><code class="language-shell">yum -y install wget &amp;&amp; wget https://download.docker.com/linux/static/stable/x86_64/docker-20.10.8.tgz
</code></pre>
<h3 id="12解压安装"><a class="header" href="#12解压安装">1.2、解压安装</a></h3>
<p>执行以下命令，对第一步下载的<code>docker-20.10.8.tgz</code>进行解压</p>
<pre><code class="language-shell">tar -zxvf docker-20.10.8.tgz
</code></pre>
<p>解压后会得到一个<code>docker</code>文件夹</p>
<p><img src="operations/docker/../../images/operations/docker/docker_extract.png" alt="avatar" /></p>
<p>执行以下命令，将 docker 命令添加到<code>/usr/bin/</code>目录下</p>
<pre><code class="language-shell">cp docker/* /usr/bin/
</code></pre>
<p>验证</p>
<p>输入以下命令，验证是否生效</p>
<pre><code class="language-shell">docker version
</code></pre>
<p><img src="operations/docker/../../images/operations/docker/docker_test.png" alt="avatar" /></p>
<p>出现上述则说明安装成功，最下面的报错可以忽略，因为目前<code>docker</code>还没启动</p>
<h3 id="13启动-docker"><a class="header" href="#13启动-docker">1.3、启动 docker</a></h3>
<p>需要配置 docker.service</p>
<p>docker.service 内容如下</p>
<pre><code class="language-shell">cat &gt; docker.service &lt;&lt; EOF
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service containerd.service
Wants=network-online.target

[Service]
Type=notify
ExecStart=/usr/bin/dockerd
ExecReload=/bin/kill -s HUP $MAINPID
TimeoutSec=0
RestartSec=2
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process

[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<p>移动 docker.service 到如下目录</p>
<pre><code class="language-shell">mv docker.service /usr/lib/systemd/system/
</code></pre>
<p>重新加载配置</p>
<pre><code class="language-shell">systemctl daemon-reload
</code></pre>
<p>启动 docker</p>
<pre><code class="language-shell">systemctl start docker
</code></pre>
<p>设置开机自启</p>
<pre><code class="language-shell">systemctl enable docker
</code></pre>
<p>验证</p>
<p>输入以下命令，即可查看 docker 是否启动</p>
<pre><code class="language-shell">systemctl status docker
</code></pre>
<p><img src="operations/docker/../../images/operations/docker/docker_status.png" alt="avatar" /></p>
<p>启动成功，到此 docker 安装结束!</p>
<h2 id="二docker-在线安装"><a class="header" href="#二docker-在线安装">二、docker 在线安装</a></h2>
<h3 id="21卸载已有-docker-服务"><a class="header" href="#21卸载已有-docker-服务">2.1、卸载已有 docker 服务</a></h3>
<pre><code class="language-shell">yum remove docker \
     docker-client \
     docker-client-latest \
     docker-common \
     docker-latest \
     docker-latest-logrotate \
     docker-logrotate \
     docker-engine
</code></pre>
<h3 id="22安装-epel-更新源"><a class="header" href="#22安装-epel-更新源">2.2、安装 epel 更新源</a></h3>
<pre><code class="language-shell">yum install -y epel-release
</code></pre>
<h3 id="23安装-docker-仓库"><a class="header" href="#23安装-docker-仓库">2.3、安装 docker 仓库</a></h3>
<pre><code>yum install -y yum-utils device-mapper-persistent-data lvm2
</code></pre>
<p>设置稳定仓库，将指定文件或 url 添加为 yum 源并启用</p>
<pre><code class="language-shell"># 官方源
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 官方源速度较慢，可以修改为添加国内原
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</code></pre>
<p><strong>如果提示<code>yum-config-manager not found</code>，请执行以下命令安装</strong></p>
<pre><code class="language-shell">yum install yum-utils
</code></pre>
<h3 id="24安装-docker"><a class="header" href="#24安装-docker">2.4、安装 docker</a></h3>
<p>按版本号排序列出存储库中可用的版本号</p>
<pre><code class="language-PlainText">(base) [root@moushi-ops-navigation-100 ~]# yum list docker-ce --showduplicates | sort -r
docker-ce.x86_64            3:24.0.6-1.el7                      docker-ce-stable
docker-ce.x86_64            3:24.0.5-1.el7                      docker-ce-stable
docker-ce.x86_64            3:24.0.4-1.el7                      docker-ce-stable
docker-ce.x86_64            3:24.0.3-1.el7                      docker-ce-stable
docker-ce.x86_64            3:24.0.2-1.el7                      docker-ce-stable
docker-ce.x86_64            3:24.0.1-1.el7                      docker-ce-stable
docker-ce.x86_64            3:24.0.0-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.6-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.5-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.4-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.3-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.2-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.1-1.el7                      docker-ce-stable
docker-ce.x86_64            3:23.0.0-1.el7                      docker-ce-stable
......
</code></pre>
<p>根据需要自行选择需要安装的版本</p>
<pre><code class="language-shell"># 默认安装最新版本docker
yum install -y docker-ce docker-ce-cli containerd.io

# 此处安装指定版本docker
yum install -y docker-ce-23.0.0-1.el7 docker-ce-cli-23.0.0-1.el7 containerd.io

# 安装docker命令补全工具
yum install -y bash-completion
</code></pre>
<h3 id="25启动-docker"><a class="header" href="#25启动-docker">2.5、启动 docker</a></h3>
<p>启动 docker</p>
<pre><code class="language-shell">systemctl start docker
</code></pre>
<p>设置开机自启</p>
<pre><code class="language-shell">systemctl enable docker
</code></pre>
<h2 id="三docker-配置"><a class="header" href="#三docker-配置">三、docker 配置</a></h2>
<h3 id="31-配置-docker-镜像下载加速器"><a class="header" href="#31-配置-docker-镜像下载加速器">3.1 配置 docker 镜像下载加速器</a></h3>
<pre><code class="language-shell">tee /etc/docker/daemon.json &lt;&lt; eof
{
    &quot;registry-mirrors&quot;: [
        &quot;https://1nj0zren.mirror.aliyuncs.com&quot;,
        &quot;https://docker.mirrors.ustc.edu.cn&quot;,
        &quot;http://f1361db2.m.daocloud.io&quot;,
        &quot;https://registry.docker-cn.com&quot;
    ]
}
eof
</code></pre>
<h3 id="32-修改-docker-的默认镜像容器数据存储位置"><a class="header" href="#32-修改-docker-的默认镜像容器数据存储位置">3.2 修改 docker 的默认镜像、容器数据存储位置</a></h3>
<p>docker 的默认存储位置是 /var/lib/docker/ ，在根目录下，docker 运行一段时间后，会导致根目录存储爆炸。所有最好将存储位置自定义到服务器存储最大的目录下。</p>
<p>然后在 <code>/etc/docker/daemon.json</code> 文件中指定默认存储路径（此路径可自定义），添加以下内容：</p>
<pre><code class="language-PlainText">&quot;data-root&quot;: &quot;/vdb/docker_images&quot;
</code></pre>
<p>修改如下</p>
<pre><code class="language-json">{
  &quot;registry-mirrors&quot;: [
    &quot;https://1nj0zren.mirror.aliyuncs.com&quot;,
    &quot;https://docker.mirrors.ustc.edu.cn&quot;,
    &quot;http://f1361db2.m.daocloud.io&quot;,
    &quot;https://registry.docker-cn.com&quot;
  ],
  &quot;data-root&quot;: &quot;/vdb/docker_images&quot;
}
</code></pre>
<h3 id="33-重新加载配置与重启-docker"><a class="header" href="#33-重新加载配置与重启-docker">3.3 重新加载配置与重启 docker</a></h3>
<p>重新加载配置</p>
<pre><code class="language-shell">systemctl daemon-reload
</code></pre>
<p>重新启动 docker</p>
<pre><code class="language-shell">systemctl restart docker
</code></pre>
<h4 id="参考文档-1"><a class="header" href="#参考文档-1">参考文档</a></h4>
<p><a href="https://blog.csdn.net/Sara_cloud/article/details/111193087">1.Docker 系列之一：在线安装 docker 和下载镜像</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-docker-compose-安装"><a class="header" href="#linux-docker-compose-安装">linux docker-compose 安装</a></h1>
<h2 id="前期准备"><a class="header" href="#前期准备">前期准备</a></h2>
<blockquote>
<p>安装之前，请先确保 docker 已经安装，如果没有安装，请参考<a href="operations/docker/linux_docker_installed.html">linux docker 安装与配置</a></p>
<p>docker-compose 各版本 <a href="https://github.com/docker/compose/releases">下载地址</a></p>
</blockquote>
<h2 id="二进制安装-docker-compose"><a class="header" href="#二进制安装-docker-compose">二进制安装 docker-compose</a></h2>
<p>1、下载对应 linux 版本的 docker-compose 二进制文件</p>
<pre><code class="language-shell">yum -y install wget
wget https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-linux-x86_64
</code></pre>
<p>2、赋予执行权限</p>
<pre><code class="language-shell">chmod +x docker-compose-linux-x86_64
</code></pre>
<p>3、移动到<code>/usr/bin/</code> 路径下，并重命名为<code>docker-compose</code></p>
<pre><code class="language-shell">mv docker-compose-linux-x86_64 /usr/bin/docker-compose
</code></pre>
<p>4、验证并查看版本</p>
<pre><code class="language-shell">docker-compose version
</code></pre>
<p>如下图所示，则安装成功</p>
<p><img src="operations/docker/../../images/operations/docker/docker-compose-version.png" alt="avatar" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="这里主要记录-docker-使用过程中遇到的问题以及解决办法"><a class="header" href="#这里主要记录-docker-使用过程中遇到的问题以及解决办法">这里主要记录 docker 使用过程中遇到的问题以及解决办法</a></h1>
<h2 id="1pip-install-upgrade-pip-报错-runtimeerror-cant-start-new-thread"><a class="header" href="#1pip-install-upgrade-pip-报错-runtimeerror-cant-start-new-thread">1、pip install –upgrade pip 报错 RuntimeError: can’t start new thread</a></h2>
<p><strong>问题描述</strong></p>
<p>docker 版本 20.10.8
python 项目打包，docker 基础镜像用的是<code>python:3.8</code>,然后构建报错如下</p>
<p><strong>RuntimeError: can’t start new thread</strong></p>
<p>✅ <strong>解决方法</strong></p>
<blockquote>
<p>基础镜像问题，将镜像由<code>python:3.8</code> 换成<code>python3.6</code>即可，前提是对<code>python</code>要求版本不高，如果对版本要求过高，需要自己单独做镜像</p>
<p>docker 版本过低问题，需要升级 docker 版本</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="redis-基础运维"><a class="header" href="#redis-基础运维">redis 基础运维</a></h1>
<p>这里主要是 redis 基础运维，涉及到 redis 基础环境搭建以及配置和相关问题的处理.</p>
<ul>
<li><a href="operations/redis/redis_binary_installed.html">redis 二进制安装与配置</a></li>
<li><a href="operations/redis/redis_docker_installed.html">redis docker-compose 安装与配置</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="redis-二进制安装与配置"><a class="header" href="#redis-二进制安装与配置">redis 二进制安装与配置</a></h1>
<blockquote>
<p>redis 各版本<a href="http://download.redis.io/releases/">下载地址</a></p>
</blockquote>
<h2 id="前期准备-1"><a class="header" href="#前期准备-1">前期准备</a></h2>
<p>依赖<code>c</code>环境</p>
<p>如果没有安装<code>c</code>环境，执行以下命令，部署安装<code>c</code>环境</p>
<pre><code class="language-shell">yum -y install gcc-c++
</code></pre>
<h2 id="二进制安装"><a class="header" href="#二进制安装">二进制安装</a></h2>
<p>这里采用了源码编译安装，版本是 7.0.8</p>
<pre><code class="language-shell"># 下载源码包
yum -y install wget &amp;&amp; wget http://download.redis.io/releases/redis-7.0.8.tar.gz

# 解压
tar -zxvf redis-7.0.8.tar.gz -C /usr/local

# 编译安装
cd /usr/local/redis-7.0.8
make &amp;&amp; make install
</code></pre>
<h2 id="配置-redis"><a class="header" href="#配置-redis">配置 redis</a></h2>
<p>redis 的默认配置文件就是位于 redis 安装目录下的 redis.conf</p>
<p>即<code>/usr/local/redis-7.0.8</code> 目录下</p>
<p>去掉 redis 注释信息，重新生成新的 redis_6379.conf</p>
<pre><code class="language-shell">cat redis.conf | grep -v &quot;#&quot; | grep -v &quot;^$&quot; &gt; redis-6379.conf
</code></pre>
<p>需要将<code>redis-6379.conf</code>配置中<code>dir</code>的值做如下修改</p>
<pre><code class="language-PlainText">dir /opt/redis/db
</code></pre>
<p>打开守护进程</p>
<pre><code class="language-PlainText">daemonize yes
</code></pre>
<p>修改 redis 日志路径</p>
<pre><code class="language-PlainText">logfile /var/log/redis/redis.log
</code></pre>
<p>以守护进程方式启动，使用本启动方式，redis 将以服务的形式存在，日志将不再打印到命令窗口中</p>
<p>在’/opt’目录下新建<code>redis</code>目录，用于存放<code>conf</code> 配置文件, <code>db</code>数据存储等</p>
<pre><code class="language-shell">mkdir -p /opt/redis/conf /opt/redis/db
mv /usr/local/redis-7.0.8/redis-6379.conf /opt/redis/conf
</code></pre>
<p>在<code>/var/log/</code>目录下创建 redis 文件夹，用于记录 redis 的日志输出</p>
<pre><code class="language-shell">mkdir /var/log/redis
</code></pre>
<h2 id="启动-redis"><a class="header" href="#启动-redis">启动 redis</a></h2>
<p>准备<code>redis.service</code>文件</p>
<pre><code class="language-shell">cat &gt; redis.service &lt;&lt; EOF
[Unit]
Description=Redis server
After=syslog.target network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
ExecStart=/bin/bash -c '/usr/local/bin/redis-server /opt/redis/conf/redis-6379.conf'
ExecStop=/bin/bash -c '/usr/local/bin/redis-cli shutdown'
Restart=always
PrivateTmp=true

[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<p>配置 redis system 启动</p>
<p>将生成的 redis.service 文件移动到 <code>/usr/lib/systemd/system/</code>目录下</p>
<pre><code class="language-shell">mv redis.service /usr/lib/systemd/system/
</code></pre>
<p>启动 redis</p>
<pre><code class="language-shell">systemctl daemon-reload
systemctl enable redis
systemctl start redis
</code></pre>
<p>查看 redis 启动状态</p>
<pre><code class="language-shell">systemctl status redis
</code></pre>
<p>如下图所示，则启动成功</p>
<p><img src="operations/redis/../../images/operations/redis/redis_status.png" alt="avatar" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="redis-docker-安装与配置"><a class="header" href="#redis-docker-安装与配置">redis docker 安装与配置</a></h1>
<h2 id="前期准备-2"><a class="header" href="#前期准备-2">前期准备</a></h2>
<p>依赖<code>docker</code>和 <code>docker-compose环境</code></p>
<p><strong>注:</strong> <code>docker</code> 环境搭建不建议用于生产环境，仅用于学习和开发环境使用</p>
<p>请参考</p>
<p>👉🏻 <a href="operations/redis/../docker/linux_docker_installed.html">docker 安装与配置</a></p>
<p>👉🏻 <a href="operations/redis/../docker/linux_docker_compose_installed.html">docker-compose 安装</a></p>
<h2 id="docker-compose-安装-redis"><a class="header" href="#docker-compose-安装-redis">docker-compose 安装 redis</a></h2>
<p><strong>1、创建专属的运维网络,用户跟其他容器交互</strong></p>
<p><strong>注:</strong> 创建之前，可以执行以下命令查看<code>ops_network</code>网络是否存在，若存在就无需创建</p>
<pre><code class="language-shell">docker network ls |grep ops_network
</code></pre>
<p>如果有如下输出就无需创建</p>
<pre><code class="language-PlainText">514e3dd06943   ops_network   bridge    local
</code></pre>
<p>如果没有<code>ops_network</code>,执行以下命令创建即可</p>
<pre><code class="language-shell">docker network create ops_network
</code></pre>
<p><strong>2、部署文件准备</strong></p>
<p>在<code>/data</code> 目录下，新建<code>redis</code>目录</p>
<pre><code class="language-shell">mkdir /data/redis
</code></pre>
<p><strong>注:</strong> <code>/data</code> 目录可选的，可以选择其他目录</p>
<p>在<code>/data/redis</code>下新建<code>docker-compose.yaml</code>, <code>run.sh</code> , <code>stop.sh</code> 三个文件和<code>conf</code>文件夹</p>
<p><code>conf</code> 文件夹下存放 redis.conf 文件</p>
<pre><code class="language-shell">mkdir -p /data/redis/conf
cat &gt; /data/redis/docker-compose.yaml&lt;&lt; EOF
version: '3.1'

services:
  redis:
    image: redis:latest
    container_name: local-redis
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    ports:
      - 9379:6379
    volumes:
      - ./data:/data
      - ./conf/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - ops_network

networks:
  ops_network:
    external: true
EOF
</code></pre>
<p>启动脚本</p>
<pre><code class="language-shell">cat &gt; /data/redis/run.sh&lt;&lt; EOF
#!/bin/bash

docker-compose -p redis-server up -d
EOF

chmod +x /data/redis/run.sh
</code></pre>
<p>停止脚本</p>
<pre><code class="language-shell">cat &gt; /data/redis/stop.sh&lt;&lt; EOF
#!/bin/bash

docker-compose -p redis-server down
EOF

chmod +x /data/redis/stop.sh
</code></pre>
<p>准备<code>redis.conf</code>配置文件</p>
<p><code>redis.conf</code></p>
<pre><code class="language-conf"># 绑定地址
bind 0.0.0.0
protected-mode yes
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300
daemonize no
supervised no
pidfile /var/run/redis_6379.pid
loglevel notice
logfile &quot;&quot;
databases 16
always-show-logo yes
save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir ./
replica-serve-stale-data yes
replica-read-only yes
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-disable-tcp-nodelay no
replica-priority 100
# 开启密码验证
requirepass Passw0rd
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no
appendonly no
appendfilename &quot;appendonly.aof&quot;
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes
lua-time-limit 5000
slowlog-log-slower-than 10000
slowlog-max-len 128
latency-monitor-threshold 0
notify-keyspace-events &quot;&quot;
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4096
stream-node-max-entries 100
activerehashing yes
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60
hz 10
dynamic-hz yes
aof-rewrite-incremental-fsync yes
rdb-save-incremental-fsync yes
</code></pre>
<p>**注:**这是从官方过滤出来的主要配置，具体配置还要以应用场景为准</p>
<p>目录结构如下</p>
<pre><code class="language-PlainText">.
├── conf
│   └── redis.conf
├── data
├── docker-compose.yaml
├── run.sh
└── stop.sh
</code></pre>
<p><strong>3、启动与关闭</strong></p>
<p>启动</p>
<pre><code class="language-shell">cd /data/redis/
./run.sh
</code></pre>
<p>关闭</p>
<pre><code class="language-shell">cd /data/redis/
./stop.sh
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mongodb-基础运维"><a class="header" href="#mongodb-基础运维">mongodb 基础运维</a></h1>
<p>这里主要是 mongodb 基础运维，涉及到 mongodb 基础环境搭建以及配置和相关问题的处理.</p>
<ul>
<li><a href="operations/mongodb/mongodb_docker_installed.html">mongodb 二进制安装与配置</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mongodb-docker-安装与配置"><a class="header" href="#mongodb-docker-安装与配置">mongodb docker 安装与配置</a></h1>
<h2 id="前期准备-3"><a class="header" href="#前期准备-3">前期准备</a></h2>
<p>依赖<code>docker</code>和 <code>docker-compose环境</code></p>
<p><strong>注:</strong> <code>docker</code> 环境搭建不建议用于生产环境，仅用于学习和开发环境使用</p>
<p>请参考</p>
<p>👉🏻 <a href="operations/mongodb/../docker/linux_docker_installed.html">docker 安装与配置</a></p>
<p>👉🏻 <a href="operations/mongodb/../docker/linux_docker_compose_installed.html">docker-compose 安装</a></p>
<h2 id="docker-compose-安装-mongodb"><a class="header" href="#docker-compose-安装-mongodb">docker-compose 安装 mongodb</a></h2>
<p><strong>1、创建专属的运维网络,用户跟其他容器交互</strong></p>
<p><strong>注:</strong> 创建之前，可以执行以下命令查看<code>ops_network</code>网络是否存在，若存在就无需创建</p>
<pre><code class="language-shell">docker network ls |grep ops_network
</code></pre>
<p>如果有如下输出就无需创建</p>
<pre><code class="language-PlainText">514e3dd06943   ops_network   bridge    local
</code></pre>
<p>如果没有<code>ops_network</code>,执行以下命令创建即可</p>
<pre><code class="language-shell">docker network create ops_network
</code></pre>
<p><strong>2、部署文件准备</strong></p>
<p>在<code>/data</code> 目录下，新建<code>mongodb</code>目录</p>
<pre><code class="language-shell">mkdir /data/mongodb
</code></pre>
<p><strong>注:</strong> <code>/data</code> 目录可选的，可以选择其他目录</p>
<p>在<code>/data/mongodb</code>下新建<code>docker-compose.yaml</code>, <code>run.sh</code> , <code>stop.sh</code></p>
<pre><code class="language-shell">mkdir -p /data/mongodb

cat &gt; /data/mongodb/docker-compose.yaml&lt;&lt; EOF
version: &quot;3.1&quot;
services:
  local-mongo:
    image: mongo:7.0.0
    restart: always
    container_name: local-mongo
    hostname: mongo
    environment:
      #用户名密码
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: Passw0rd
    ports:
      - 33017:27017
    volumes:
      - ./data:/data/db
    networks:
      - ops_network

networks:
  ops_network:
    external: true
EOF
</code></pre>
<p>启动脚本</p>
<pre><code class="language-shell">cat &gt; /data/mongodb/run.sh&lt;&lt; EOF
#!/bin/bash

docker-compose -p mongodb-server up -d
EOF

chmod +x /data/mongodb/run.sh
</code></pre>
<p>停止脚本</p>
<pre><code class="language-shell">cat &gt; /data/mongodb/stop.sh&lt;&lt; EOF
#!/bin/bash

docker-compose -p mongodb-server down
EOF

chmod +x /data/mongodb/stop.sh
</code></pre>
<p>目录结构如下</p>
<pre><code class="language-PlainText">├── data
├── docker-compose.yaml
├── run.sh
└── stop.sh
</code></pre>
<p><strong>3、启动与关闭</strong></p>
<p>启动</p>
<pre><code class="language-shell">cd /data/mongodb/
./run.sh
</code></pre>
<p>关闭</p>
<pre><code class="language-shell">cd /data/mongodb/
./stop.sh
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="elasticsearch-基础运维"><a class="header" href="#elasticsearch-基础运维">elasticsearch 基础运维</a></h1>
<p>这里主要是 elasticsearch 基础运维，涉及到 elasticsearch 基础环境搭建以及配置和相关问题的处理.</p>
<ul>
<li><a href="operations/elasticsearch/es_docker_installed.html">elasticsearch docker-compose 安装与配置(7.1.0 版本)</a></li>
<li><a href="operations/elasticsearch/es_ik_installed.html">elasticsearch ik 分词器安装(7.1.0 版本)</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="elasticsearch-docker-安装与配置7100-版本"><a class="header" href="#elasticsearch-docker-安装与配置7100-版本">elasticsearch docker 安装与配置(7.10.0 版本)</a></h1>
<h2 id="前期准备-4"><a class="header" href="#前期准备-4">前期准备</a></h2>
<p>依赖<code>docker</code>和 <code>docker-compose环境</code></p>
<p><strong>注:</strong> <code>docker</code> 环境搭建不建议用于生产环境，仅用于学习和开发环境使用</p>
<p>请参考</p>
<p>👉🏻 <a href="operations/elasticsearch/../docker/linux_docker_installed.html">docker 安装与配置</a></p>
<p>👉🏻 <a href="operations/elasticsearch/../docker/linux_docker_compose_installed.html">docker-compose 安装</a></p>
<h2 id="docker-compose-安装-mongodb-1"><a class="header" href="#docker-compose-安装-mongodb-1">docker-compose 安装 mongodb</a></h2>
<p><strong>1、创建专属的运维网络,用户跟其他容器交互</strong></p>
<p><strong>注:</strong> 创建之前，可以执行以下命令查看<code>ops_network</code>网络是否存在，若存在就无需创建</p>
<pre><code class="language-shell">docker network ls |grep ops_network
</code></pre>
<p>如果有如下输出就无需创建</p>
<pre><code class="language-PlainText">514e3dd06943   ops_network   bridge    local
</code></pre>
<pre><code class="language-shell">docker network create ops_network
</code></pre>
<p><strong>2、部署文件准备</strong></p>
<p>在<code>/data</code> 目录下，新建<code>elasticsearch</code>目录</p>
<pre><code class="language-shell">mkdir /data/elasticsearch
</code></pre>
<p><strong>注:</strong> <code>/data</code> 目录可选的，可以选择其他目录</p>
<p>在<code>/data/elasticsearch</code>下新建<code>docker-compose.yaml</code>, <code>run.sh</code> , <code>stop.sh</code>, <code>.env</code> 和 <code>es_data</code>文件夹</p>
<pre><code class="language-shell">mkdir -p /data/elasticsearch/es_data

cat &gt; /data/mongodb/docker-compose.yaml&lt;&lt; EOF
version: '3.1'

services:
  elasticsearch:
    image: &quot;docker.elastic.co/elasticsearch/elasticsearch:${ES_VERSION}&quot;
    container_name: elasticsearch
    environment:
      TZ: Asia/Shanghai
      LANG: en_US.UTF-8
      discovery.type: single-node
      ES_JAVA_OPTS: &quot;-Xmx512m -Xms512m&quot;
      ELASTIC_PASSWORD: &quot;passw0rd&quot; # elastic账号密码
    volumes:
      - /etc/localtime:/etc/localtime
      - ./es_data:/usr/share/elasticsearch/data
    ports:
      - &quot;12200:9200&quot;
      - &quot;12300:9300&quot;
    user: &quot;1000:1000&quot;
    networks:
      - ops_network

  kibana:
    depends_on:
      - elasticsearch
    image: &quot;docker.elastic.co/kibana/kibana:${ES_VERSION}&quot;
    container_name: kibana
    environment:
      - ELASTICSEARCH_URL=http://elasticsearch:9200
    volumes:
      - /etc/localtime:/etc/localtime
    ports:
      - &quot;8601:5601&quot;
    links:
      - elasticsearch
    networks:
      - ops_network

networks:
  ops_network:
    external: true
EOF
</code></pre>
<p>下面两个操作很重要，给<code>es</code>持久化文件赋予权限，不然启动会报权限问题</p>
<pre><code class="language-shell"># 给es_data es_config kibana_config赋予权限，不然启动会报文件权限问题，这个很重要
sudo chown -R 1000:1000 /data/elasticsearch/es_data


# 设置es版本
cat &gt; /data/elasticsearch/.env &lt;&lt; EOF
ES_VERSION=7.1.0
EOF
</code></pre>
<p>启动脚本</p>
<pre><code class="language-shell">cat &gt; /data/elasticsearch/run.sh&lt;&lt; EOF
#!/bin/bash

docker-compose -p es-server up -d
EOF

chmod +x /data/elasticsearch/run.sh
</code></pre>
<p>停止脚本</p>
<pre><code class="language-shell">cat &gt; /data/elasticsearch/stop.sh&lt;&lt; EOF
#!/bin/bash

docker-compose -p es-server down
EOF

chmod +x /data/elasticsearch/stop.sh
</code></pre>
<p>目录结构如下</p>
<pre><code class="language-PlainText">.
├── .env
├── docker-compose.yaml
├── es_data
├── run.sh
└── stop.sh
</code></pre>
<p><strong>3、启动与关闭</strong></p>
<p>启动</p>
<pre><code class="language-shell">cd /data/elsaticsearch/
./run.sh
</code></pre>
<p>关闭</p>
<pre><code class="language-shell">cd /data/elsaticsearch/
./stop.sh
</code></pre>
<p><strong>4、挂载出配置文件</strong></p>
<p>执行如下命令，将 elasticsearch 和 kibana config 文件拷贝出来</p>
<pre><code class="language-shell">cd /data/elasticsearch
# 拷贝es config 文件
docker cp elasticsearch:/usr/share/elasticsearch/config es_config
# 拷贝 kibana config文件
docker cp kibana:/usr/share/kibana/config kibana_config
# 修改文件权限
chown -R 1000:1000 es_config kibana_config
</code></pre>
<p>关闭服务</p>
<pre><code class="language-shell">cd /data/elsaticsearch/
./stop.sh
</code></pre>
<p>将<code>docker-compose.yaml</code>文件挂载配置修改
修改后的内容如下</p>
<pre><code class="language-yaml">version: '3.1'

services:
  elasticsearch:
    image: 'docker.elastic.co/elasticsearch/elasticsearch:${ES_VERSION}'
    container_name: elasticsearch
    environment:
      TZ: Asia/Shanghai
      LANG: en_US.UTF-8
      discovery.type: single-node
      ES_JAVA_OPTS: '-Xmx512m -Xms512m'
      ELASTIC_PASSWORD: 'Passw0rd'
    volumes:
      - /etc/localtime:/etc/localtime
      - ./es_config:/usr/share/elasticsearch/config # 新增
      - ./es_data:/usr/share/elasticsearch/data
    ports:
      - '12200:9200'
      - '12300:9300'
    user: '1000:1000'
    networks:
      - ops_network

  kibana:
    depends_on:
      - elasticsearch
    image: 'docker.elastic.co/kibana/kibana:${ES_VERSION}'
    container_name: kibana
    environment:
      - ELASTICSEARCH_URL=http://elasticsearch:9200
    volumes:
      - /etc/localtime:/etc/localtime
      - ./kibana_config:/usr/share/kibana/config # 新增
    ports:
      - '8601:5601'
    links:
      - elasticsearch
    networks:
      - ops_network

networks:
  ops_network:
    external: true
</code></pre>
<p>启动</p>
<pre><code class="language-shell">cd /data/elsaticsearch/
./run.sh
</code></pre>
<p>完整项目目录如下</p>
<pre><code class="language-PlainText">├── .env
├── docker-compose.yaml
├── es_config
├── es_data
├── kibana_config
├── run.sh
├── stop.sh
└── zips
</code></pre>
<p><strong>5、配置密码</strong></p>
<p><strong>修改配置</strong></p>
<p>设置密码需要 启用 X-Pack 安全功能</p>
<p>需要修改<code>/data/elasticsearch/es_config/elasticsearch.yaml</code>文件 和 <code>/data/elasticsearch/kibana_config/kibana.yml</code></p>
<p><code>elasticsearch.yaml</code>修改内容如下，内容为新增内容</p>
<pre><code class="language-yaml"># enable xpack
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
</code></pre>
<pre><code class="language-yaml">cluster.name: 'docker-cluster'
network.host: 0.0.0.0
# 开启es跨域
http.cors.enabled: true
http.cors.allow-origin: &quot;*&quot;
http.cors.allow-headers: Authorization
# 省略其他配置
# ...

# 在最后新增
# enable xpack
xpack.security.enabled: true
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
</code></pre>
<p><code>kibana.yml</code> 修改内容如下,内容为新增内容</p>
<pre><code class="language-yaml">elasticsearch.username: 'elastic' # es账号
elasticsearch.password: '123456' # es密码
</code></pre>
<p><strong>重启服务</strong></p>
<p>参考步骤 3，启动与关闭</p>
<p><strong>重置密码</strong></p>
<p>进入<code>elasticsearch</code> 容器</p>
<pre><code class="language-shell">docker exec -it elasticsearch bash
</code></pre>
<p>手动设置密码</p>
<pre><code class="language-shell">elasticsearch-setup-passwords interactive
</code></pre>
<p>进入交互式操作,设置完密码即可,如下图</p>
<p><img src="operations/elasticsearch/../../images/operations/elasticsearch/es_update_password_1.png" alt="avatar" /></p>
<p><img src="operations/elasticsearch/../../images/operations/elasticsearch/es_update_password_2.png" alt="avatar" /></p>
<p>在容器里访问 es</p>
<pre><code class="language-shell">curl 127.0.0.1:9200 -u elastic:123456
</code></pre>
<p>有正常返回即可</p>
<p>如下图
<img src="operations/elasticsearch/../../images/operations/elasticsearch/es_update_password_3.png" alt="avatar" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="elasticsearch-ik-分词器安装7100-版本"><a class="header" href="#elasticsearch-ik-分词器安装7100-版本">elasticsearch ik 分词器安装(7.10.0 版本)</a></h1>
<p>👉🏻 <a href="https://github.com/medcl/elasticsearch-analysis-ik">elasticsearch ik 分词器 github</a></p>
<p>👉🏻 <a href="https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.10.0/elasticsearch-analysis-ik-7.10.0.zip">elasticsearch ik 分词器 7.10.0 下载地址</a></p>
<h2 id="前期准备-5"><a class="header" href="#前期准备-5">前期准备</a></h2>
<p><code>elasticserach</code> 已经安装部署完成</p>
<p>安装部署请参考 👉🏻 <a href="operations/elasticsearch/es_docker_installed.html">elasticsearch docker-compose 安装与配置(7.10.0 版本)</a></p>
<p><strong>1、停止服务</strong></p>
<pre><code class="language-shell">cd /data/elasticserach/
.stop.sh
</code></pre>
<p><strong>2、准备 plugins 文件</strong></p>
<pre><code class="language-shell">mkdir /data/elasticsearch/plugins

chown -R 1000:1000 /data/elasticsearch/plugins
</code></pre>
<p><strong>3、更新 docker-compose.yaml</strong>文件</p>
<p>需要将<code>/data/elasticsearch/docker-compose.yaml</code>文件做如下更改</p>
<pre><code class="language-yaml">volumes:
  - /etc/localtime:/etc/localtime
  - ./es_config:/usr/share/elasticsearch/config
  - ./es_data:/usr/share/elasticsearch/data
  - ./plugins:/usr/share/elasticsearch/plugins # 新增
</code></pre>
<p>完整<code>docker-compose.yaml</code>文件如下</p>
<pre><code class="language-yaml">version: '3.1'

services:
  elasticsearch:
    image: 'docker.elastic.co/elasticsearch/elasticsearch:${ES_VERSION}'
    container_name: elasticsearch
    environment:
      TZ: Asia/Shanghai
      LANG: en_US.UTF-8
      discovery.type: single-node
      ES_JAVA_OPTS: '-Xmx512m -Xms512m'
      ELASTIC_PASSWORD: 'Passw0rd'
    volumes:
      - /etc/localtime:/etc/localtime
      - ./es_config:/usr/share/elasticsearch/config
      - ./es_data:/usr/share/elasticsearch/data
      - ./plugins:/usr/share/elasticsearch/plugins # 新增
    ports:
      - '12200:9200'
      - '12300:9300'
    user: '1000:1000'
    networks:
      - ops_network

  kibana:
    depends_on:
      - elasticsearch
    image: 'docker.elastic.co/kibana/kibana:${ES_VERSION}'
    container_name: kibana
    environment:
      - ELASTICSEARCH_URL=http://elasticsearch:9200
    volumes:
      - /etc/localtime:/etc/localtime
      - ./kibana_config:/usr/share/kibana/config
    ports:
      - '8601:5601'
    links:
      - elasticsearch
    networks:
      - ops_network

networks:
  ops_network:
    external: true
</code></pre>
<p><strong>3、准备 ik 文件并配置</strong></p>
<pre><code class="language-shell"># 新建zips 文件，用于备份存放zip文件
mkdir -p /data/elasticsearch/zips

# 新建 analysis-ik 插件名称
mkdir -p /data/elasticsearch/plugins/analysis-ik

# 下载ik 分词器插件
cd /data/elasticsearch/plugins/analysis-ik
yum -y install wget &amp;&amp; wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.10.0/elasticsearch-analysis-ik-7.10.0.zip
yum -y install unzip &amp;&amp; unzip elasticsearch-analysis-ik-7.10.0.zip


# zip 文件移动到创建好的zips 目录下
mv /data/elasticsearch/plugins/analysis-ik/elasticsearch-analysis-ik-7.10.0.zip /data/elasticsearch/zips

# 再次重新赋予下权限
chown -R 1000:1000 /data/elasticsearch/plugins/
</code></pre>
<p>**注:**如果下载失败，请通过其他渠道下载后上传到<code>/data/elasticsearch/plugins</code>目录下</p>
<p>目录结构如下</p>
<pre><code class="language-PlainText">├── .env
├── docker-compose.yaml
├── es_config
├── es_data
├── kibana_config
├── plugins
├── run.sh
├── stop.sh
└── zips
</code></pre>
<p><strong>4、启动服务</strong></p>
<p>启动</p>
<pre><code class="language-shell">cd /data/elsaticsearch/
./run.sh
</code></pre>
<p><strong>4、问题排查</strong></p>
<p>如果遇到了下面的问题</p>
<pre><code class="language-PlainText">&quot;Caused by: java.nio.file.FileSystemException: /usr/share/elasticsearch/plugins/httpclient-4.5.2.jar/plugin-descriptor.properties: Not a directory&quot;,
</code></pre>
<p>说明你把 ik 分词器的文件放到了<code>plugins</code>目录下，导致的报错</p>
<p>请参考 👉🏻 <a href="https://blog.csdn.net/dxtljly/article/details/127102211">记一次 docker 安装 elasticsearch 遇到的坑</a></p>
<p><strong>5、测试 ik 分词器</strong></p>
<p>在<code>kibana</code>中请求如下内容</p>
<pre><code class="language-elasticsearch">GET _analyze
{
  &quot;analyzer&quot;: &quot;ik_max_word&quot;,
  &quot;text&quot;:&quot;我是中国人&quot;
}
</code></pre>
<p>响应内容</p>
<pre><code class="language-json">{
  &quot;tokens&quot;: [
    {
      &quot;token&quot;: &quot;我&quot;,
      &quot;start_offset&quot;: 0,
      &quot;end_offset&quot;: 1,
      &quot;type&quot;: &quot;CN_CHAR&quot;,
      &quot;position&quot;: 0
    },
    {
      &quot;token&quot;: &quot;是&quot;,
      &quot;start_offset&quot;: 1,
      &quot;end_offset&quot;: 2,
      &quot;type&quot;: &quot;CN_CHAR&quot;,
      &quot;position&quot;: 1
    },
    {
      &quot;token&quot;: &quot;中国人&quot;,
      &quot;start_offset&quot;: 2,
      &quot;end_offset&quot;: 5,
      &quot;type&quot;: &quot;CN_WORD&quot;,
      &quot;position&quot;: 2
    },
    {
      &quot;token&quot;: &quot;中国&quot;,
      &quot;start_offset&quot;: 2,
      &quot;end_offset&quot;: 4,
      &quot;type&quot;: &quot;CN_WORD&quot;,
      &quot;position&quot;: 3
    },
    {
      &quot;token&quot;: &quot;国人&quot;,
      &quot;start_offset&quot;: 3,
      &quot;end_offset&quot;: 5,
      &quot;type&quot;: &quot;CN_WORD&quot;,
      &quot;position&quot;: 4
    }
  ]
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-基础操作"><a class="header" href="#git-基础操作">git 基础操作</a></h1>
<p>这里主要是 git 基础操作，涉及到项目开发与运维中的代码推送，回滚等</p>
<ul>
<li>
<p><a href="operations/git/git_operation.html">git 版本控制</a></p>
</li>
<li>
<p><a href="operations/git/git_clone_without_pass.html">git http 方式免密克隆代码</a></p>
</li>
<li>
<p><a href="operations/git/git_dev_specification.html">git 开发管理规范</a></p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-版本控制"><a class="header" href="#git-版本控制">Git 版本控制</a></h1>
<h2 id="一git-常用命令"><a class="header" href="#一git-常用命令">一、git 常用命令</a></h2>
<h2 id="11-查看帮助"><a class="header" href="#11-查看帮助">1.1 查看帮助</a></h2>
<p>git 或者 git help 即可查看帮助信息</p>
<pre><code class="language-bash">git

git help
</code></pre>
<p>加上某一参数即可查看某一参数详细信息</p>
<p>如查看 add 信息</p>
<pre><code class="language-bash">git help add
</code></pre>
<p>文档内容显示过长，按 f 键可以向下翻页，b 想上翻页，按 q 退出</p>
<h2 id="12-git-配置"><a class="header" href="#12-git-配置">1.2 git 配置</a></h2>
<p>git 配置有三个范围</p>
<ul>
<li>系统范围</li>
<li>全局范围 global</li>
<li>项目范围</li>
</ul>
<p>一般用全局范围配置</p>
<h3 id="121-配置全局用户信息"><a class="header" href="#121-配置全局用户信息">1.2.1 配置全局用户信息</a></h3>
<pre><code class="language-bash">git config --global user.name &quot;einsli&quot;
git config --global user.email &quot;einsli@123.com&quot;
</code></pre>
<h3 id="122-查看配置信息"><a class="header" href="#122-查看配置信息">1.2.2 查看配置信息</a></h3>
<pre><code class="language-bash">git config --list
</code></pre>
<p>output 如下</p>
<pre><code>color.ui=true
user.name=einsli
user.email=einsli@123.com
credential.helper=cache  --timeout=200
filter.media.clean=git-media-clean %f
filter.media.smudge-git-media-smudge %f
alias.co=checkout
core.excludesfile=/Users/einsli/.gitignore_global
</code></pre>
<h3 id="123-重新配置用户名可使用-unset-命令"><a class="header" href="#123-重新配置用户名可使用-unset-命令">1.2.3 重新配置用户名，可使用 unset 命令</a></h3>
<pre><code class="language-bash">git config --unset --global user.name

git config --list
</code></pre>
<p>output 如下</p>
<pre><code>color.ui=true
user.email=einsli@123.com
credential.helper=cache  --timeout=200
filter.media.clean=git-media-clean %f
filter.media.smudge-git-media-smudge %f
alias.co=checkout
core.excludesfile=/Users/einsli/.gitignore_global
</code></pre>
<p>用户名选项已经移除</p>
<h3 id="124-git-输出主题颜色配置"><a class="header" href="#124-git-输出主题颜色配置">1.2.4 git 输出主题颜色配置</a></h3>
<pre><code class="language-bash">git config --global color.ui true
</code></pre>
<h3 id="125-产看-git-配置"><a class="header" href="#125-产看-git-配置">1.2.5 产看 git 配置</a></h3>
<p>git 配置会保存在当前用户主目录下面</p>
<pre><code class="language-bash">cat ~/.gitconfig
</code></pre>
<p>output 如下</p>
<pre><code>[color]
				ui = true
[user]
				email = einsli@123.com
				name = einsli
[core]
[web]
[credential]
				helper = cache --timeout=200
[filter &quot;media&quot;]
				clean = git-media-clean %f
				smudge = git-media-smudge %f
[alias]
				co = check out
[core]
				excludesfile = /Users/einsli/.gitignore_global
</code></pre>
<h3 id="126-git-别名设置"><a class="header" href="#126-git-别名设置">1.2.6 git 别名设置</a></h3>
<p>设置别名用 alias，比如给 check out 设置别名</p>
<pre><code class="language-bash">git config ==global alias.co check out
</code></pre>
<p>可以在系统级别设置别名, 当前平台 MacOS 平台，用户配置文件名为.bash_profile</p>
<pre><code class="language-bash">vim ~/.bash_profile

# 将 alias goc=&quot;git check out&quot; 添加到第一行即可

# 退出 并更新
souroce ~/.bash_profile
</code></pre>
<h3 id="127-忽略跟踪文件-全局"><a class="header" href="#127-忽略跟踪文件-全局">1.2.7 忽略跟踪文件 全局</a></h3>
<p>设置全局列表中忽略的文件</p>
<pre><code class="language-bash">git config --global core.excludesfile=~/.gitignore_global
</code></pre>
<h3 id="128-忽略跟踪文件-项目级别"><a class="header" href="#128-忽略跟踪文件-项目级别">1.2.8 忽略跟踪文件 项目级别</a></h3>
<p>在项目目录下，创建.gitignore</p>
<p>输入需要忽略的内容即可</p>
<p>比如忽略所有后缀名为.log 的文件</p>
<p>.gitngnore</p>
<pre><code>*.log
</code></pre>
<p>可参考如下地址给出的 gitignore 的模板</p>
<p><a href="https://github.com/github/gitignore">https://github.com/github/gitignore</a></p>
<h2 id="13-项目操作"><a class="header" href="#13-项目操作">1.3 项目操作</a></h2>
<h3 id="131-git-init"><a class="header" href="#131-git-init">1.3.1 git init</a></h3>
<p>例如当前目录有个 test-server，需要进行 git 追踪</p>
<pre><code>cd test-server
git init
</code></pre>
<p>output 如下</p>
<pre><code>Initialized empty Git repository in /Users/einsli/Desktop/server-test/.git
</code></pre>
<p>生成之后，git 会跟踪 server-test 目录下所有的目录变化，这样就可以使用 git 提供的版本控制</p>
<p>查看生成的.git 文件</p>
<pre><code class="language-bash">ls .git
</code></pre>
<p>output 如下</p>
<pre><code>HEAD        config        hooks    objects
branches    description   info      refs
</code></pre>
<p>如果不想用 git 追踪此项目，删除.git 文件即可</p>
<h3 id="132-git-commit"><a class="header" href="#132-git-commit">1.3.2 git commit</a></h3>
<p>项目提交</p>
<p>新创建一个 index.html 文件</p>
<p>提交前可查看当前状态信息</p>
<pre><code class="language-bash">git status
</code></pre>
<p>output 如下</p>
<pre><code>On branch master

Initial commit

Untracked files:
  (use &quot;git add &lt;file&gt;...&quot; to include in what will be committed)
				index.html

nothing added to commit but untracked files present(use &quot;git add&quot; to track)
</code></pre>
<p>commit 之前先执行 git add</p>
<pre><code class="language-bash">git add index.html
</code></pre>
<p>然后查看下状态</p>
<pre><code class="language-bash">git status
</code></pre>
<p>output 如下</p>
<pre><code>On branch master

Initial commit

Changes to be committed:
  (use &quot;git tm --cached &lt;file&gt;...&quot; to unstage)
		  new files: index.html
</code></pre>
<p>确认提交</p>
<pre><code class="language-bash">git commit -m '条件index.html'
</code></pre>
<p>output 如下</p>
<pre><code>1 file changed, 10 insertions(+)
create mode 100644 index.html
</code></pre>
<p>然后查看下状态</p>
<pre><code class="language-bash">git status
</code></pre>
<p>output 如下</p>
<pre><code>On branch master
nothing to commit, working directory clean1.
</code></pre>
<h3 id="133-git-log"><a class="header" href="#133-git-log">1.3.3 git log</a></h3>
<p>查看用户操作记录</p>
<pre><code class="language-bash">git log
git log --oneline # 每行显示一次提交
</code></pre>
<p>output 如下</p>
<pre><code>commit dagdgakhregjakgjkf7423gdgdjk4334gue61
Author: einsli &lt;einsli@123.com&gt;
Date: Sun Nov 11:07:00 2020 +0800
		添加index.html文件
</code></pre>
<h3 id="134-git-diff"><a class="header" href="#134-git-diff">1.3.4 git diff</a></h3>
<p>查看文件修改前和修改后的区别</p>
<p>比较的文件为工作区暂与存区(git add 后里面的内容)里面的内容</p>
<pre><code class="language-bash">git diff index.html
</code></pre>
<p>如果想比较 respository 与暂存区里面的内容，则需要输入下面命令</p>
<pre><code class="language-bash">git diff --staged
</code></pre>
<h3 id="135-git-mv"><a class="header" href="#135-git-mv">1.3.5 git mv</a></h3>
<p>重命名 git 已经追踪的文件</p>
<p>方法一</p>
<p>例如:</p>
<p>当前目录下新建 style.css，添加内容后并提交</p>
<pre><code class="language-bash">git add style.css
git commit -m &quot;添加style.css&quot;
</code></pre>
<p>在可视化界面将 style.css 重命名为 them.css</p>
<p>查看当前状态</p>
<pre><code class="language-bash">git status
</code></pre>
<p>output 如下</p>
<pre><code>On branch master
Changes not stages for commit:
		(use &quot;git add/rm &lt;file&gt;...&quot; to update what will be committed)
		(use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)
				deleted; sytle.css
Untracked files:
		(use &quot;git add &lt;file&gt;...&quot; to include in what will will be committed)
				theme.css
no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)
</code></pre>
<p>由此看来，git 不知道通过可视化界面重命名了此文件</p>
<p>可以这样执行</p>
<pre><code>git rm style.css
# output
# rm 'style.css'
git add theme.css
</code></pre>
<p>查看状态</p>
<pre><code class="language-bash">git status
</code></pre>
<pre><code>Changes to be committed:
		(use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)
					renamed: style.css -&gt;them.css
</code></pre>
<p>然后提交即可</p>
<pre><code class="language-bash">git commit -m &quot;重命名style.css为them.css&quot;
</code></pre>
<p>方法二</p>
<p>git mv</p>
<pre><code class="language-bash">git mv theme.css einsli-theme.css
</code></pre>
<p>然后产看状态</p>
<pre><code class="language-bash">git status
</code></pre>
<p>output 如下</p>
<pre><code class="language-bash">Changes to be committed:
		(use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)
					renamed: theme.css -&gt;einsli-them.css
</code></pre>
<p>然后提交即可</p>
<p><strong>git 不会跟踪空白的目录</strong></p>
<p>在当前目录下创建 css 文件</p>
<pre><code class="language-bash">mkdir css
</code></pre>
<p>查看状态</p>
<pre><code class="language-bash">git status
</code></pre>
<p>output 如下</p>
<pre><code class="language-bash">On branch master
Nothing to commit, working directory clean
</code></pre>
<h3 id="136-git-rm"><a class="header" href="#136-git-rm">1.3.6 git rm</a></h3>
<p>删除文件有两种方法</p>
<p>方法一</p>
<p>将文件通过可视化命令直接删除</p>
<p>方法二</p>
<p>git rm 文件名</p>
<p>删除单个文件</p>
<pre><code class="language-bash">git rm einsli-theme.css
</code></pre>
<h3 id="137-恢复放放或修改的文件"><a class="header" href="#137-恢复放放或修改的文件">1.3.7 恢复放放或修改的文件</a></h3>
<p>比如删除 index.html</p>
<pre><code class="language-bash">git rm index.html
</code></pre>
<p>删除后我们想恢复，可使用 git checkout 命令</p>
<pre><code class="language-bash">git checkout HEAD -- index.html
</code></pre>
<p><strong>注</strong>: HEAD 表示当前提交，— 表示当前分支， index.html 表示要恢复的文件</p>
<p>删除之后进行了提交怎么恢复文件？</p>
<p>比如删除了 index.html，并进行了提交，要恢复 index.html 改怎么做?</p>
<p>需要把 index.html 恢复到上一次提交的状态</p>
<pre><code class="language-bash">git checkout HEAD^ -- index.html
</code></pre>
<p><strong>注</strong>: HEAD^ 表示最近一次提交的上一次提交，HEAD^^表示最近一次提交的上两次提交</p>
<h3 id="138-git-revert"><a class="header" href="#138-git-revert">1.3.8 git revert</a></h3>
<p>恢复文件的历史版本</p>
<p>比如新添加了 bootstrap 框架，并进行了提交，后面不想用，想恢复之前的状态</p>
<pre><code class="language-bash">git log --oneline
</code></pre>
<p>output 如下</p>
<pre><code>b6b86f 添加了JQuery 1.2.1
bb95e87 添加了Bootstrap框架
aa5673a 恢复了index.html
</code></pre>
<p>不想用 boorstrap 框架，可以执行以下操作</p>
<pre><code class="language-bash">git revert bb95e87
</code></pre>
<p>会弹出编辑器，添加描述内容或者直接保存后即可</p>
<p>然后在查看下提交日志</p>
<pre><code class="language-bash">git log --oneline
</code></pre>
<p>output 如下</p>
<pre><code>aaab1c0 Revert &quot;添加了Bootstrap框架&quot;
b6b86f 添加了JQuery 1.2.1
bb95e87 添加了Bootstrap框架
aa5673a 恢复了index.html
</code></pre>
<h3 id="139-git-reset"><a class="header" href="#139-git-reset">1.3.9 git reset</a></h3>
<p>提交方式</p>
<ul>
<li>—soft 软重置：不会影响工作区与暂存区</li>
<li>—hard ：他会把工作区与暂存区恢复到某个工作状态</li>
<li>mixed：会把暂存区里面的恢复到某个状态</li>
</ul>
<p>展示:</p>
<p>查看提交记录</p>
<pre><code class="language-bash">git log --oneline
</code></pre>
<p>output 如下</p>
<pre><code>aaab1c0 Revert &quot;添加了Bootstrap框架&quot;
b6b86f 添加了JQuery 1.2.1
bb95e87 添加了Bootstrap框架
aa5673a 恢复了index.html
</code></pre>
<p>使用 git reset</p>
<p>— soft</p>
<pre><code class="language-bash">git reset --soft b6b86
</code></pre>
<p>提交后会覆盖掉 aaab1c0 这次提交</p>
<p>— mixed</p>
<p>执行后暂存区里面的内容不存在了</p>
<p><strong>注</strong> 与—soft 项目，少了类似 git add 的操作</p>
<p>—hard</p>
<p>相当于直接重置到 b6b86 提交后的状态</p>
<h3 id="1310-git-stash"><a class="header" href="#1310-git-stash">1.3.10 git stash</a></h3>
<p>可以把修改暂时存到一个地方，保存工作进度</p>
<p>例如当前目录创建了一个新的 txt 文档，但是提交的时候，不想将当前状态提交</p>
<pre><code class="language-bash">git stash save &quot;修改了txt文档&quot;
</code></pre>
<p>查看保存的工作进度</p>
<pre><code class="language-bash">git stash list
</code></pre>
<p>output 如下</p>
<pre><code>stash{0}: On text-server: 修改了txt文档
</code></pre>
<p>查看保存工作进度与当前工作进度有什么区别</p>
<pre><code class="language-bash">git stash show -p stash{0}
</code></pre>
<p><strong>注</strong> -p 以补丁的方式查看 stash{0}为 stash 工作代号</p>
<p>恢复工作进度</p>
<pre><code>git stash apply stash{0}
</code></pre>
<p><strong>注</strong>：stash{0}为 stash 代号</p>
<p>删除工作进度</p>
<pre><code>git stash drop stash{0}
</code></pre>
<p><strong>注</strong> stash{0}为工作代号</p>
<h3 id="1311-git-log"><a class="header" href="#1311-git-log">1.3.11 git log</a></h3>
<p>查看提交的日志</p>
<p>查看详细信息</p>
<pre><code class="language-bash">git long
</code></pre>
<p>显示简单的日志列表</p>
<pre><code class="language-bash">git log --oneline
</code></pre>
<p>控制输出的行数，如显示最近的 5 条</p>
<pre><code class="language-bash">git log --oneline -5
</code></pre>
<p>可以查看指定作者的提交</p>
<pre><code class="language-bash">git log --online --author=&quot;einsli&quot;
</code></pre>
<p>git log 也支持 grep 语法</p>
<p>比如显示关于 index.html 的提交</p>
<pre><code class="language-bash">git log --oneline --grep=&quot;index.html&quot;
</code></pre>
<p>也可以指定日志</p>
<p>比如指定在 2020 年 11 月 1 号之前的提交</p>
<pre><code class="language-bash">git log --oneline --before=&quot;2020-11-01&quot;
</code></pre>
<p>找出一个礼拜之前的提交</p>
<pre><code class="language-bash">git log --oneline --before=&quot;1 week&quot;
</code></pre>
<p>找出三天前的提交</p>
<pre><code class="language-bash">git log --oneline --before=&quot;3 days&quot;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-http-方式免密克隆代码"><a class="header" href="#git-http-方式免密克隆代码">git http 方式免密克隆代码</a></h1>
<p>免密拉取配置
执行以下命令，在<code>home</code>目录下，创建<code>.git-credentials</code>文件 写入如下内容</p>
<pre><code class="language-shell">cat &gt; $HOME/.git-credentials &lt;&lt; EOF
https://username:password@git.gitxx.com
EOF
</code></pre>
<p>其中 <code>username</code>替换为自己的用户名，<code>password</code>替换为登录的密码</p>
<p>比如 <a href="https://einsli:passw0rd@git.einsli.com">https://einsli:passw0rd@git.einsli.com</a></p>
<p>执行以下命令更新配置</p>
<pre><code class="language-shell">git config --global credential.helper store
</code></pre>
<p>执行以下命令验证</p>
<pre><code class="language-shell">git config --list
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">credential.helper=store
</code></pre>
<p>或者查看一下<code>$HOME/.gitconfig</code> 文件</p>
<pre><code class="language-shell">cat $HOME/.gitconfig
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">[credential]
	helper = store
</code></pre>
<p>这时候再用 git 拉取仓库就不需要输入用户名和密码了。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-开发管理规范"><a class="header" href="#git-开发管理规范">git 开发管理规范</a></h1>
<h2 id="1创建-git-仓库"><a class="header" href="#1创建-git-仓库">1、创建 Git 仓库</a></h2>
<p>1、创建 README.md</p>
<p>2、创建.gitignore 文件，最基本包含如下内容</p>
<pre><code class="language-plainText">.idea
log
.DS_Store
__pycache__
</code></pre>
<h2 id="2分支管理"><a class="header" href="#2分支管理">2、分支管理</a></h2>
<p><strong>环境</strong></p>
<div class="table-wrapper"><table><thead><tr><th>简称</th><th>备注</th></tr></thead><tbody>
<tr><td>dev</td><td>开发和测试环境</td></tr>
<tr><td>prod</td><td>生产环境</td></tr>
</tbody></table>
</div>
<p><strong>分支划分</strong>
master 和 dev 不可直接提交，需要 pull request, code review 后 merge</p>
<div class="table-wrapper"><table><thead><tr><th>分支</th><th>名称</th><th>环境</th><th>备注</th></tr></thead><tbody>
<tr><td>master</td><td>主分支</td><td>PROD</td><td>用于正式版本部署，结合 git tag 使用</td></tr>
<tr><td>dev</td><td>测试分支</td><td>DEV</td><td>用于测试部署，实现持续集成，便于测试</td></tr>
<tr><td>feature</td><td>需求开发分支</td><td>DEV</td><td>用于功能开发，由项目管理人员指定创建</td></tr>
<tr><td>bugfix</td><td>bug 修复分支</td><td>DEV</td><td>用于修复 dev 分支测试出的 bug</td></tr>
<tr><td>hotfix</td><td>紧急修复分支</td><td>PROD</td><td>用于修复 master 分支使用过程中发现的 bug</td></tr>
</tbody></table>
</div>
<p><img src="operations/git/../../images/operations/git/git_dev_process.png" alt="avatar" /></p>
<ol>
<li>需求收集、论证和分解后，指定开发人员从 dev 分支根据需求创建 feature 分支；</li>
<li>开发人员在 feature 分支开发，本地开发测试完成后提交到分支；</li>
<li>先将 dev 与 feature 分支合并，并修复合并的 bug；</li>
<li>在 bug 修复后将 feature 分支提交 pull request 到 dev 分支，由主开发人员审查后合并；</li>
<li>测试人员在 dev 分支更新后，进行测试，并记录 bug；</li>
<li>相关人员新建 bug 分支，修复 bug，提交 pull request，由主开发人员审查后合并；</li>
<li>测试通过后由项目/技术负责人进行 code review，提交到 master 分支，使用 git tag 标记版本，并进行 release 发版，将相关模型和数据打包存储；</li>
<li>线上使用过程中，发现 bug，创建 hotfix 分支，修复后，由项目/技术负责人合并到 master 分支，并同步到 dev 分支。</li>
</ol>
<h2 id="3gitlab-的-group-管理"><a class="header" href="#3gitlab-的-group-管理">3、GitLab 的 group 管理</a></h2>
<ol>
<li>分为几大基础 group：预研项目，建设性项目，产品，通用算法服务</li>
<li>基础 group 下面根据来源单元、承研单位等建 subgroup，subgroup 下面建项目的 subgroup</li>
<li>一个项目所有代码仓库都在一个 subgroup 里面</li>
<li>一个项目的代码仓库共用一个主的名称，根据前后端来进行后缀命名</li>
<li>一个项目必须有 doc 仓储，记录所有产品设计文档、设计图、技术设计文档、接口文档、测试文档，尽量使用 Markdown 格式。</li>
</ol>
<p><img src="operations/git/../../images/operations/git/git_proj.png" alt="avatar" /></p>
<h2 id="commit-日志规范"><a class="header" href="#commit-日志规范">commit 日志规范</a></h2>
<p>建议参考规范：</p>
<p>e.g</p>
<p>fix(首页模块)：修复弹窗 JS Bug。</p>
<p>type  表示动作类型，可分为:</p>
<p>fix：修复 xxx Bug</p>
<p>feat：新增 xxx 功能</p>
<p>test：调试 xxx 功能</p>
<p>style：变更 xxx 代码格式或注释</p>
<p>docs：变更 xxx 文档</p>
<p>refactor：重构 xxx 功能或方法</p>
<p>scope  表示影响范围，可分为：模块、类库、方法等。</p>
<p>subject  表示简短描述，最好不要超过 60 个字，如果有相关 Bug 的编号，建议在描述中加上。<br></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="云原生"><a class="header" href="#云原生">云原生</a></h1>
<p>这里主要是云原生运维，涉及到 docker,k8s,prometheus 监控等一系列云原生相关组件的安装配置与使用问题.</p>
<ul>
<li><a href="cloud_operations/monitor.html">监控</a></li>
<li><a href="cloud_operations/kubernetes.html">kubernets</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="云原生监控"><a class="header" href="#云原生监控">云原生监控</a></h1>
<p>这里主要是 监控，涉及到 prometheus alertmanager grafana 等相关组件的安装使用与监控配置等.</p>
<ul>
<li>
<p><a href="cloud_operations/monitor/n9e_install.html">夜莺部署安装</a></p>
</li>
<li>
<p><a href="cloud_operations/monitor/n9e_ldap_config.html">夜莺配置 ldap 单点登录</a></p>
</li>
<li>
<p><a href="cloud_operations/monitor/alert_prom_sql.html">prometheus 监控 sql</a></p>
</li>
<li>
<p><a href="cloud_operations/monitor/prometheus_domain_monitor.html">prometheus 监控域名</a></p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="夜莺安装与配置"><a class="header" href="#夜莺安装与配置">夜莺安装与配置</a></h1>
<p><a href="https://flashcat.cloud/docs/content/flashcat-monitor/nightingale-v6/install/intro/">夜莺官方部署文档</a></p>
<p>夜莺官方推荐二进制安装，具体安装步骤参考与官网</p>
<h2 id="一二进制安装夜莺"><a class="header" href="#一二进制安装夜莺">一、二进制安装夜莺</a></h2>
<h3 id="11-部署安装-mysql"><a class="header" href="#11-部署安装-mysql">1.1 部署安装 mysql</a></h3>
<p>安装 mysql</p>
<pre><code class="language-shell">yum -y install mariadb*
systemctl enable mariadb
systemctl restart mariadb
</code></pre>
<p>设置登陆密码</p>
<pre><code class="language-shell">mysql -e &quot;SET PASSWORD FOR 'root'@'localhost' = PASSWORD('passw0rd');&quot;
</code></pre>
<p>开启远程登录</p>
<p>登录 mysql 后，执行一下语句，开启远程登录</p>
<pre><code class="language-sql">GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'passw0rd' WITH GRANT OPTION;
</code></pre>
<h3 id="12-部署安装-redis"><a class="header" href="#12-部署安装-redis">1.2 部署安装 redis</a></h3>
<p>这里采用二进制安装，请参考 <a href="cloud_operations/monitor/../../operations/redis/redis_binary_installed.html">redis 二进制安装与配置</a></p>
<h3 id="13-部署夜莺"><a class="header" href="#13-部署夜莺">1.3 部署夜莺</a></h3>
<p><strong>安装夜莺</strong></p>
<p>夜莺最新安装包<a href="https://flashcat.cloud/download/nightingale/">下载地址</a>,截止到目前，最近版本是<code>v6.1.0</code></p>
<p>(1) 创建个 n9e 的目录，后面把 n9e 相关的文件解压到这里</p>
<pre><code class="language-shell">mkdir -p /opt/n9e &amp;&amp; cd /opt/n9e
</code></pre>
<p>(2) 下载 n9e 发布包，amd64 是 x84 的包，下载站点也提供 arm64 的包，如果需要其他平台的包则要自行编译了</p>
<pre><code class="language-shell">tarball=n9e-v6.0.1-linux-amd64.tar.gz
urlpath=https://download.flashcat.cloud/${tarball}
wget -q $urlpath || exit 1
</code></pre>
<p>(3)解压安装包到<code>/opt/n9e</code></p>
<pre><code class="language-shell">tar -zxvf n9e-v6.0.1-linux-amd64.tar.gz -C /opt/n9e/
</code></pre>
<p>(4) 解压缩之后，可以看到 n9e.sql 是建表语句，导入数据库</p>
<pre><code class="language-shell">mysql -uroot -ppassw0rd &lt; n9e.sql
</code></pre>
<p><strong>注:</strong> passw0rd 为第一步创建 mariab 时候的创建的密码</p>
<p>(5) 修改<code>n9e</code>数据库配置</p>
<p>配置文件在安装目录下 <code>etc/config.toml</code></p>
<pre><code class="language-shell">DSN=&quot;root:passw0rd@tcp(127.0.0.1:3306)/n9e_v6?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&amp;allowNativePasswords=true&quot;
</code></pre>
<p>(6) 启动测试</p>
<p>启动 n9e</p>
<pre><code class="language-shell">nohup ./n9e &amp;&gt; n9e.log &amp;
</code></pre>
<p>检查 n9e.log 是否有异常日志，检查端口是否在监听，正常应该监听在 17000</p>
<pre><code class="language-shell">ss -tlnp|grep 17000
</code></pre>
<p>启动成功如下图
<img src="cloud_operations/monitor/../../images/n9e/n9e_check_17000.png" alt="avatar" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="夜莺配置-ldap-单点登录"><a class="header" href="#夜莺配置-ldap-单点登录">夜莺配置 ldap 单点登录</a></h1>
<p>夜莺版本 v6.1.0</p>
<p>进入夜莺界面后，在系统配置中，找到单点登录，如下图</p>
<p><img src="cloud_operations/monitor/../../images/n9e/n9e_ldap_config_1.png" alt="avatar" /></p>
<p>选择<code>ldap</code>后，进行相应的修改即可</p>
<p>参考配置如下</p>
<pre><code class="language-conf">Enable = true # 开启
Host = 'ldap_host'
Port = 389
BaseDn = 'dc=n9e,dc=com,dc=cn' # ldap相关配置 仅供参考
BindUser = 'cn=Manager,dc=n9e,dc=com,dc=cn' # ldap 相关配置，仅供参考
BindPass = 'passw0rd'
# openldap format e.g. (&amp;(uid=%s))
# AD format e.g. (&amp;(sAMAccountName=%s))
AuthFilter = '(&amp;(uid=%s))'
CoverAttributes = true
TLS = false
StartTLS = true
DefaultRoles = ['Standard']

[Attributes]
Nickname = 'cn'
Phone = 'mobile'
Email = 'mail'
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prometheus-监控告警-sql"><a class="header" href="#prometheus-监控告警-sql">prometheus 监控告警 sql</a></h1>
<p>这里主要是针对日常用到的监控告警 prom_sql 的记录与描述</p>
<p>版本信息</p>
<blockquote>
<p>prometheus, version 2.19.2</p>
<p>(branch: HEAD, revision: c448ada63d83002e9c1d2c9f84e09f55a61f0ff7)</p>
</blockquote>
<h3 id="一主机相关"><a class="header" href="#一主机相关">一、主机相关</a></h3>
<p>主机存活 sql(node-exporter 服务异常或者服务器宕掉就告警)</p>
<p><code>sql up{app=&quot;node-exporter&quot;,instance=~&quot;192.*&quot;} == 0 </code></p>
<p><strong>注:这里对主机的 ip 进行了相关的筛选，把 instance 里面的匹配值换成自己对应的 ip 网段即可</strong></p>
<p>主机内存告警(内存使用率超过 96 告警)</p>
<pre><code class="language-sql">((node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes) * 100 &gt; 96
</code></pre>
<p>主机 CPU 监控(CPU 使用率超过 90 告警)</p>
<pre><code class="language-sql">100 - ((avg by(instance, job, env) (irate(node_cpu_seconds_total{mode=&quot;idle&quot;}[30s]))) * 100) &gt; 90
</code></pre>
<p>主机网络流量监控(超过 200M 就告警)</p>
<pre><code class="language-sql">avg by(instance, job, env) (irate(node_network_receive_bytes_total{device!=&quot;lo&quot;}[5m]) * 8) / (1000 * 1000) &gt; 200
</code></pre>
<p>主机磁盘监控(超过 90 就告警)</p>
<pre><code class="language-sql">100 - (node_filesystem_avail_bytes{instance=~&quot;172.16.*&quot;} * 100) / node_filesystem_size_bytes{instance=~&quot;172.16.*&quot;} &gt; 90
</code></pre>
<h3 id="二k8s-相关"><a class="header" href="#二k8s-相关">二、k8s 相关</a></h3>
<p>线上 k8s 节点 CPU 监控告警(2 分钟内，CPU 使用率超过 90 就告警)</p>
<pre><code class="language-sql">100 - avg by(instance) (rate(node_cpu_seconds_total{mode=&quot;idle&quot;,instance =~ &quot;172.18.*&quot;}[2m])) * 100 &gt; 90
</code></pre>
<p>注:跟主机 CPU 监控是同一类，单独列出来放到 k8s 里面了</p>
<p>线上 k8s 节点状态监控</p>
<pre><code class="language-sql">kube_node_status_condition{condition=&quot;Ready&quot;,status=&quot;true&quot;, node=~&quot;cn-hangzhou.*&quot;} == 0
</code></pre>
<p>线上 k8s 节点磁盘监控(磁盘使用率超过 90 就告警)</p>
<pre><code class="language-sql">100 - (node_filesystem_avail_bytes{instance=~&quot;172.18.*&quot;} * 100) / node_filesystem_size_bytes{instance=~&quot;172.18.*&quot;} &gt; 90
</code></pre>
<p>注:跟主机 磁盘 监控是同一类，单独列出来放到 k8s 里面了</p>
<p>线上 k8s 节点内存监控告警(内存使用率超过 95 就告警)</p>
<pre><code class="language-sql">100 - node_memory_MemAvailable_bytes{instance =~ &quot;172.18.*&quot;} / node_memory_MemTotal_bytes{instance =~ &quot;172.18.*&quot;} * 100 &gt; 95
</code></pre>
<h3 id="三pod-相关"><a class="header" href="#三pod-相关">三、pod 相关</a></h3>
<p>线上 pod CPU 使用率监控 (5 分钟之内，CPU 使用率超过 80 就告警)</p>
<pre><code class="language-sql">(sum by(name) (rate(container_cpu_usage_seconds_total{image!=&quot;&quot;,namespace=~&quot;moushi-(prod|pre)&quot;}[5m])) * 100) &gt; 80
</code></pre>
<p>线上 pod 内存使用率监控(pod 内存使用率超过 80 就告警)</p>
<pre><code class="language-sql">(sum(container_memory_working_set_bytes{id!=&quot;/&quot;,namespace=~&quot;moushi-(prod|pre)&quot;}) BY (instance,name,container,pod_name,namespace) / sum(container_spec_memory_limit_bytes{id!=&quot;/&quot;,namespace=~&quot;moushi-(prod|pre)&quot;} &gt; 0) BY (instance,name,container,pod_name,namespace) * 100) &gt; 98
</code></pre>
<p>线上 pod 网络流量监控(pod 流入流量 1 分钟之内超过 50M 就告警)</p>
<pre><code class="language-sql">sum by(name) (irate(container_network_receive_bytes_total{container_name=&quot;POD&quot;,namespace=~&quot;moushi-(pre|prod)&quot;}[1m])) &gt; 1024 * 1024 * 50
</code></pre>
<p>pod 启动失败监控(10 分钟之内，启动失败一次就告警)</p>
<pre><code class="language-sql">avg_over_time(kube_pod_container_status_waiting_reason{namespace=~&quot;moushi-(pre|prod)&quot;,reason!=&quot;PodInitializing&quot;, reason!=&quot;ContainerCreating&quot;}[10m]) == 1
</code></pre>
<p>线上 pod 重启监控(5 分钟之内，pod 重启次数超过一次就告警)</p>
<pre><code class="language-sql">increase(kube_pod_container_status_restarts_total{namespace=~&quot;moushi-(prod|pre)&quot;}[5m]) &gt; 0
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prometheus-域名状态码监控"><a class="header" href="#prometheus-域名状态码监控">prometheus 域名状态码监控</a></h1>
<h2 id="一安装-blackbox"><a class="header" href="#一安装-blackbox">一、安装 blackbox</a></h2>
<h3 id="11-二进制安装"><a class="header" href="#11-二进制安装">1.1 二进制安装</a></h3>
<p>是 Prometheus 社区提供的官方黑盒监控解决方案，其允许用户通过：HTTP、 HTTPS、 DNS、 TCP 以及 ICMP 的方式对网络进行探测</p>
<p>👉🏻 blackbox <a href="https://github.com/prometheus/blackbox_exporter/releases">下载地址</a></p>
<p>执行以下命令，下载并安装<code>blackbox</code></p>
<pre><code class="language-shell"># 下载二进制文件
wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.24.0/blackbox_exporter-0.24.0.linux-amd64.tar.gz

# 解压二进制文件
tar -zxvf blackbox_exporter-0.24.0.linux-amd64.tar.gz -C /opt/

# 重命名
mv blackbox_exporter-0.24.0.linux-amd64 blackbox_exporter
</code></pre>
<p>解压后的文件结构如下</p>
<pre><code class="language-PlainText">├── blackbox_exporter # 二进制文件
├── blackbox.yml      # 配置文件
├── LICENSE
└── NOTICE
</code></pre>
<p>配置文件可使用如下配置</p>
<pre><code class="language-yaml">modules:
  http_2xx: # http 检测模块  Blockbox-Exporter 中所有的探针均是以 Module 的信息进行配置
    prober: http
    timeout: 10s
    http:
      valid_http_versions: ['HTTP/1.1', 'HTTP/2']
      valid_status_codes: [200] # 这里最好作一个返回状态码，在grafana作图时，有明示---陈刚注释。
      method: GET
      preferred_ip_protocol: 'ip4'
  http_post_2xx: # http post 监测模块
    prober: http
    timeout: 10s
    http:
      valid_http_versions: ['HTTP/1.1', 'HTTP/2']
      method: POST
      preferred_ip_protocol: 'ip4'
  tcp_connect: # TCP 检测模块
    prober: tcp
    timeout: 10s
  dns: # DNS 检测模块
    prober: dns
    dns:
      transport_protocol: 'tcp' # 默认是 udp
      preferred_ip_protocol: 'ip4' # 默认是 ip6
      query_name: 'kubernetes.default.svc.cluster.local'
</code></pre>
<p>启动<code>blackbox_exporter</code></p>
<pre><code class="language-shell">./blackbox_exporter --config=blackbox.yml
</code></pre>
<h3 id="12-k8s-安装"><a class="header" href="#12-k8s-安装">1.2 k8s 安装</a></h3>
<p>准备安装文件 <code>blackbox_app.yaml</code></p>
<pre><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: blackbox-config
  namespace: kube-prometheus
data:
  blackbox.yml: |-
    modules:
      http_2xx:  # http 检测模块  Blockbox-Exporter 中所有的探针均是以 Module 的信息进行配置
        prober: http
        timeout: 10s
        http:
          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]
          valid_status_codes: [200]
          method: GET
          preferred_ip_protocol: &quot;ip4&quot;
      http_post_2xx: # http post 监测模块
        prober: http
        timeout: 10s
        http:
          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]
          method: POST
          preferred_ip_protocol: &quot;ip4&quot;
      tcp_connect:  # TCP 检测模块
        prober: tcp
        timeout: 10s
      dns:  # DNS 检测模块
        prober: dns
        dns:
          transport_protocol: &quot;tcp&quot;  # 默认是 udp
          preferred_ip_protocol: &quot;ip4&quot;  # 默认是 ip6
          query_name: &quot;kubernetes.default.svc.cluster.local&quot;
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: blackbox
  namespace: kube-prometheus
spec:
  selector:
    matchLabels:
      app: blackbox
  template:
    metadata:
      labels:
        app: blackbox
    spec:
      containers:
        - image: prom/blackbox-exporter:v0.16.0
          name: blackbox
          args:
            - --config.file=/etc/blackbox_exporter/blackbox.yml # ConfigMap 中的配置文件
            - --log.level=error # 错误级别控制
          ports:
            - containerPort: 9115
          volumeMounts:
            - name: config
              mountPath: /etc/blackbox_exporter
      volumes:
        - name: config
          configMap:
            name: blackbox-config
---
apiVersion: v1
kind: Service
metadata:
  name: blackbox
  namespace: kube-prometheus
spec:
  selector:
    app: blackbox
  ports:
    - port: 9115
      targetPort: 9115
</code></pre>
<p>执行一下命令，进行安装</p>
<pre><code class="language-shell">kubectl apply -f blackbox_app.yaml
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">configmap/blackbox-config created
deployment.apps/blackbox created
service/blackbox created
</code></pre>
<h2 id="二配置-prometheus"><a class="header" href="#二配置-prometheus">二、配置 prometheus</a></h2>
<p>在<code>prometheus</code>中配置<code>blackbox</code>抓取配置</p>
<pre><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: kube-prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      scrape_timeout: 15s
    scrape_configs:
    - job_name: 'prometheus'
      static_configs:
      - targets: ['localhost:9090']

    # 配置http模块,没有采用参考文档，因为检测的是外部域名
    - job_name: 'kubernetes-http-services'
      metrics_path: /probe
      params:
        module: [http_2xx]  # 使用定义的http模块
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox:9115  # 这里的9115是Exporter的默认端口
</code></pre>
<p>首先获取 <code>targets</code> 实例的 <code>__address__</code>值写进<code>__param_target</code>，<code>__param_&lt;name&gt;</code>形式的标签里的 name 和它的值会被添加到发送到黑盒的 http 的 header 的 params 当作键值，例如<code>__param_module</code>对应 params 里的 module。
然后获取<code>__param_target</code>的值，并覆写到 <code>instance</code> 标签中，覆写 Target 实例的 <code>__address__</code> 标签值为 <code>BlockBoxExporter</code> 实例的访问地址，向 <code>blackbox:9115</code> 发送请求获取实例的 <code>metrics</code> 信息。</p>
<p>然后更新配置：</p>
<pre><code class="language-shell">kubectl apply -f prometheus-cm.yaml
</code></pre>
<p>输出如下</p>
<pre><code class="language-PlainText">configmap/prometheus-config configured
</code></pre>
<p>重新加载配置</p>
<pre><code class="language-shell"># 这里配置了域名解析
curl -X POST http://prometheus.com/-/reload
</code></pre>
<p>打开<code>prometheus</code> 找到<code>target</code>，就可以看到上面定义的<code>kubernetes-http-services</code>任务了</p>
<p>service-http
<img src="cloud_operations/monitor/../../images/monitor/blackbox_prometheus_target_http.png" alt="avatar" /></p>
<p>目前还没添加域名，所以为空</p>
<p>要添加监控的域名，就在<code>kubernetes-http-services</code>添加<code>static_configs</code></p>
<p><code>kubernetes-http-services</code>配置如下</p>
<pre><code class="language-yaml">- job_name: 'kubernetes-http-services'
  metrics_path: /probe
  params:
    module: [http_2xx] # 使用定义的http模块
  static_configs:
    - targets:
    - https://www.baidu.com
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox:9115 # 这里的9115是Exporter的默认端口
</code></pre>
<p>保存后，执行上述更新配置命令和<code>reload</code>命令</p>
<p>然后重新打开<code>promehtues</code>的<code>target</code>,已经注册上去了</p>
<p><img src="cloud_operations/monitor/../../images/monitor/blackbox_prometheus_target_instance.png" alt="avatar" /></p>
<h2 id="三prom-sql"><a class="header" href="#三prom-sql">三、prom sql</a></h2>
<p>配置<code>prometheus</code>监控告警，检查状态码非<code>200</code></p>
<pre><code class="language-sql">probe_http_status_code != 200
</code></pre>
<p>如果除了<code>200</code>还有其他状态码，如<code>301</code>、<code>424</code> 等，可以用如下<code>sql</code></p>
<pre><code class="language-sql">probe_http_status_code != 200 unless probe_http_status_code == 424
</code></pre>
<p>此<code>prom sql</code>表示，查找状态码非<code>200</code>或者非<code>424</code>的数据</p>
<p>另外一种查询方式是，查询 10 分钟之内，状态码有变化的数据</p>
<pre><code class="language-sql">changes(probe_http_status_code[10m])
</code></pre>
<h4 id="参考文档-2"><a class="header" href="#参考文档-2">参考文档</a></h4>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1782670">使用 Prometheus 进行黑盒(blackbox) 监控</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="云原生-kubernetes"><a class="header" href="#云原生-kubernetes">云原生 kubernetes</a></h1>
<p>这里主要涉及到<code>kubernetes</code>相关知识已经运维相关的问题!</p>
<ul>
<li><a href="cloud_operations/kubernetes/kubernetes_sa.html">kubernetes sa 相关问题</a></li>
<li><a href="cloud_operations/kubernetes/kubernetes_issues.html">kubernetes 相关问题</a>
<ul>
<li><a href="cloud_operations/kubernetes/kubernetes_issues/k8s_secret_issues.html">kubernetes secret 相关问题</a></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="k8s-sa-相关问题"><a class="header" href="#k8s-sa-相关问题">k8s sa 相关问题</a></h1>
<p>这里主要是记录对 k8s sa 的配置以及其相关运维的问题</p>
<ul>
<li><a href="cloud_operations/kubernetes/kubernetes_sa/k8s_sa_kubeconfig.html">kubernetes 基于 sa 创建 kubeconfig 访问(集群版)</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="k8s-基于-sa-创建-kubeconfig-访问集群版"><a class="header" href="#k8s-基于-sa-创建-kubeconfig-访问集群版">k8s 基于 sa 创建 kubeconfig 访问（集群版）</a></h1>
<h2 id="1创建-sa"><a class="header" href="#1创建-sa">1、创建 sa</a></h2>
<p>执行以下命令创建 serviceaccount</p>
<pre><code class="language-shell">kubectl create sa devops
</code></pre>
<h2 id="2创建-clusterrole"><a class="header" href="#2创建-clusterrole">2、创建 clusterrole</a></h2>
<p><code>clusterrole.yaml</code></p>
<pre><code class="language-yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  creationTimestamp: '2022-12-11T07:37:26Z'
  name: devops
  resourceVersion: '2468820'
  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterroles/devops
  uid: 21ba0efa-bca7-4a39-868f-f48858ddb591
rules:
  - apiGroups:
      - '*'
    resources:
      - '*'
    verbs:
      - get
      - list
      - watch
      - create
      - delete
      - update
      - patch
</code></pre>
<h2 id="3创建-clusterrolebinding"><a class="header" href="#3创建-clusterrolebinding">3、创建 clusterrolebinding</a></h2>
<p><code>clusterrolebinding.yaml</code></p>
<pre><code class="language-yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: devops
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: devops
subjects:
  - kind: ServiceAccount
    name: devops
    namespace: default
</code></pre>
<h2 id="4生成-kubeconfig"><a class="header" href="#4生成-kubeconfig">4、生成 kubeconfig</a></h2>
<p>假设 k8s 的 apiserver 地址为：<strong><a href="https://192.168.1.236:16443">https://192.168.1.236:16443</a></strong></p>
<p>假设 k8s 集群的 ca 证书文件目录为：<strong>/etc/kubernetes/pki/ca.pem</strong></p>
<h3 id="41-获取-sa-token"><a class="header" href="#41-获取-sa-token">4.1 获取 sa token</a></h3>
<pre><code class="language-shell">kubectl get secret $(kubectl get secret -A | grep devops | awk '{print $2}') -o=jsonpath='{.data.token}' | base64 -d
</code></pre>
<h3 id="42-生成-kubeconfig-步骤"><a class="header" href="#42-生成-kubeconfig-步骤">4.2 生成 kubeconfig 步骤</a></h3>
<pre><code class="language-shell">KUBE_APISERVER=https://192.168.1.236:16443
DEVOPS_TOKEN=`kubectl get secret $(kubectl get secret -A | grep devops | awk '{print $2}') -o=jsonpath='{.data.token}' | base64 -d` # 这里为上一步获取token的命令

# 设置集群信息
kubectl config set-cluster kubernetes \ # kubernetes是集群名字
--certificate-authority=/etc/kubernetes/pki/ca.pem \ # 这个ca是k8s集群的ca证书
--embed-certs=true \
--server=${KUBE_APISERVER} \ # 这个是api-server的连接地址，通过kubectl cluster-info能看到
--kubeconfig=devops.kubeconfig

# 设置客户端认证凭据
kubectl config set-credentials devops-user \ # devops-user表示凭据的用户名
--token=${DEVOPS_TOKEN} \ # token可通过第一个步骤中得到
--kubeconfig=devops.kubeconfig

# 设置集群信息和用户的上下文信息
kubectl config set-context devops@kubernetes \ # 设置上下文名字
--cluster=kubernetes \ # kubernetes集群名字，跟设置集群信息中保持一致
--user=devops-user \ # 第二步设置凭据的用户名
--kubeconfig=devops.kubeconfig

# 切换当前上下文
kubectl config use-context devops@kubernetes \
--kubeconfig=./devops.kubeconfig
</code></pre>
<h2 id="5命令测试"><a class="header" href="#5命令测试">5、命令测试</a></h2>
<pre><code class="language-shell">kubectl --kubeconfig=./devops.kubeconfig get pod -A
</code></pre>
<h2 id="6使用"><a class="header" href="#6使用">6、使用</a></h2>
<p>将生成的<code>devops.config</code>放到 用户家目录下的<code>.kube</code>文件下，并重命名为<code>config</code>即可，例如</p>
<pre><code class="language-shell">mkdir ~/.kube

mv devops.config ~/.kube/config
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="k8s-相关问题"><a class="header" href="#k8s-相关问题">k8s 相关问题</a></h1>
<p>这里主要是记录对 k8s 版本之间的配置以及其相关运维的问题</p>
<p><a href="cloud_operations/kubernetes/kubernetes_issues/k8s_secret_issues.html">kubernetes secret 相关问题</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="k8s-新版本问题处理"><a class="header" href="#k8s-新版本问题处理">k8s 新版本问题处理</a></h1>
<h4 id="1创建-sa-不会自动生成相应-secret-问题"><a class="header" href="#1创建-sa-不会自动生成相应-secret-问题">1、创建 sa 不会自动生成相应 secret 问题</a></h4>
<blockquote>
<p>k8s serviceaccount 创建后没有生成对应的 secret</p>
</blockquote>
<p>方法如下</p>
<p>方式 1 使用 TokenRequest API 来生成 token，获取方式如下</p>
<ul>
<li>使用 client-go 或者其他 api 调用工具来获取某个 serviceaccount 的 token</li>
<li>创建 yaml，使用 kubectl apply -f</li>
<li>使用 kubectl create token -n xxx <serviceaccount-name> 来获取一个临时的 token, 默认 1 小时</li>
</ul>
<p>方式 2 创建 secret token，创建后从 secret 的 token 字段拿就可以了</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Secret
metadata:
  name: secret-sa-sample
  annotations:
    kubernetes.io/service-account.name: 'sa-name' # 这里填写serviceAccountName
type: kubernetes.io/service-account-token
</code></pre>
<h3 id="参考文章"><a class="header" href="#参考文章">参考文章</a></h3>
<ul>
<li><a href="https://www.soulchild.cn/post/2945">参考文章: k8s serviceaccount 创建后没有生成对应的 secret</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.24.md#urgent-upgrade-notes">changelog</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/pull/108309">相关 pr</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="language.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
