# CPU 负载过高问题排查

## 场景:1：MySQL 进程飙升 900%

大家在使用 MySQL 过程，想必都有遇到过 CPU 突然过高，或者达到 200%以上的情况。

数据库执行查询或数据修改操作时，系统需要消耗大量的 CPU 资源维护从存储系统、内存数据中的一致性。

并发量大并且大量 SQL 性能低的情况下，比如字段是没有建立索引，则会导致快速 CPU 飙升，如果还开启了慢日志记录，会导致性能更加恶化。生产上有 MYSQL 飙升 900% 的恶劣情况。

定位过程：

- 使用 top 命令观察，确定是 mysqld 导致还是其他原因。
- 如果是 mysqld 导致的，show processlist，查看 session 情况，确定是不是有消耗资源的 sql 在运行。
- 找出消耗高的 sql，看看执行计划是否准确， index 是否缺失，或者实在是数据量太大造成。

处理过程：

- kill 掉这些线程(同时观察 cpu 使用率是否下降)， 一般来说，肯定要 kill 掉这些线程(同时观察 cpu 使用率是否下降)，等进行相应的调整(比如说加索引、改 sql、改内存参数)之后，再重新跑这些 SQL。
- 进行相应的调整(比如说加索引、改 sql、改内存参数)index 是否缺失，如果是，则 建立索引。也有可能是每个 sql 消耗资源并不多，但是突然之间，有大量的 session 连进来导致 cpu 飙升，这种情况就需要跟应用一起来分析为何连接数会激增，再做出相应的调整，比如说限制连接数等;
- 优化的过程，往往不是一步完成的，而是一步一步，执行一项优化措辞，再观察，再优化。

## 场景 2：Java 进程飙升 900%

一般来说 Java 进程不做大量 CPU 运算，正常情况下，CPU 应该在 100~200% 之间，

但是，一旦高并发场景，要么走到了死循环，要么就是在做大量的 GC, 容易出现这种 CPU 飙升的情况，CPU 飙升 900%，是完全有可能的。

定位过程：

CPU 飙升问题定位的一般步骤是：

- 首先通过 top 指令查看当前占用 CPU 较高的进程 PID；
- 查看当前进程消耗资源的线程 PID：top -Hp PID
- 通过 print 命令将线程 PID 转为 16 进制，根据该 16 进制值去打印的堆栈日志内查询，查看该线程所驻留的方法位置。
- 通过 jstack 命令，查看栈信息，定位到线程对应的具体代码。
- 分析代码解决问题。

处理过程：

1、如果是空循环，或者空自旋。

> 处理方式：可以使用 Thread.sleep 或者加锁，让线程适当的阻塞。

2、在循环的代码逻辑中，创建大量的新对象导致频繁 GC。比如，从 mysql 查出了大量的数据，比如 100W 以上等等。

> 处理方式：可以减少对象的创建数量，或者，可以考虑使用 对象池。

3、其他的一些造成 CPU 飙升的场景，比如 selector 空轮训导致 CPU 飙升 。

> 处理方式：参考 Netty 源码，无效的事件查询到了一定的次数，进行 selector 重建。

#### 参考文档

- [离谱！CPU 狂飙 900%，这怎么处理？](https://mp.weixin.qq.com/s/nibiyuuvn8sytJEippTRTg)
